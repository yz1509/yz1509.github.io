<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.7.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <meta name="msapplication-config" content="/images/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Redis Modules APIs 介绍。">
<meta name="keywords" content="Redis">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis Modules APIs">
<meta property="og:url" content="https://yz1509.github.io/posts/3720c85c/index.html">
<meta property="og:site_name" content="HTT">
<meta property="og:description" content="Redis Modules APIs 介绍。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-08-27T02:59:06.852Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis Modules APIs">
<meta name="twitter:description" content="Redis Modules APIs 介绍。">

<link rel="canonical" href="https://yz1509.github.io/posts/3720c85c/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Redis Modules APIs | HTT</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HTT</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">ふわふわ時間</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yz1509.github.io/posts/3720c85c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/k-on.jpg">
      <meta itemprop="name" content="KyoAni">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HTT">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis Modules APIs
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-08-27 10:45:48 / 修改时间：10:59:06" itemprop="dateCreated datePublished" datetime="2020-08-27T10:45:48+08:00">2020-08-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Redis Modules APIs 介绍。</p>
<a id="more"></a>
<hr>
<p><a href="https://redis.io/topics/modules-api-ref" target="_blank" rel="noopener">原文地址</a> <a href="https://github.com/redis/redis/blob/unstable/src/module.c" target="_blank" rel="noopener">源码地址</a></p>
<h2 id="内存分配与释放">内存分配与释放</h2>
<p>使用 Redis Module 提供的内存分配器的优点如入门篇中所说，此处不再赘述。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Use like malloc() */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">RedisModule_Alloc</span><span class="params">(<span class="keyword">size_t</span> bytes)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Use like calloc() */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">RedisModule_Calloc</span><span class="params">(<span class="keyword">size_t</span> nmemb, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Use like realloc() for memory obtained with RedisModule_Alloc() */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">RedisModule_Realloc</span><span class="params">(<span class="keyword">void</span> *ptr, <span class="keyword">size_t</span> bytes)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Use like free() for memory obtained by RedisModule_Alloc()</span></span><br><span class="line"><span class="comment"> * and RedisModule_Realloc() */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_Free</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Use like strdup() but returns memory allocated with RedisModule_Alloc(). */</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">RedisModule_Strdup</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return heap allocated memory that will be freed automatically when the</span></span><br><span class="line"><span class="comment"> * module callback function returns */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">RedisModule_PoolAlloc</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">size_t</span> bytes)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Enable automatic memory management. the function must be called as the first</span></span><br><span class="line"><span class="comment"> * function of a command implementation that wants to use automatic memory. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_AutoMemory</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="redismodulestring">RedisModuleString</h2>
<h3 id="create">Create</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Create a new module string object by copying the len bytes starting ar ptr. */</span></span><br><span class="line"><span class="function">RedisModuleString *<span class="title">RedisModule_CreateString</span><span class="params">(RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                            <span class="keyword">const</span> <span class="keyword">char</span> *ptr, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Create a new module string object from a printf format and arguments.</span></span><br><span class="line"><span class="comment"> * The string is created using the sds formatter function sdscatvprintf(). */</span></span><br><span class="line"><span class="function">RedisModuleString *<span class="title">RedisModule_CreateStringPrintf</span><span class="params">(RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                  <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Create a new module string from a long long integer */</span></span><br><span class="line"><span class="function">RedisModuleString *<span class="title">RedisModule_CreateStringFromLongLong</span><span class="params">(RedisModuleCtx *ctx</span></span></span><br><span class="line"><span class="function"><span class="params">                                                        <span class="keyword">long</span> <span class="keyword">long</span> ll)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Create a new module string from a double */</span></span><br><span class="line"><span class="function">RedisModuleString *<span class="title">RedisModule_CreateStringFromDouble</span><span class="params">(RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      <span class="keyword">double</span> d)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Create a new module string from a long double */</span></span><br><span class="line"><span class="function">RedisModuleString *<span class="title">RedisModule_CreateStringFromLongDouble</span><span class="params">(RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">long</span> <span class="keyword">double</span> ld, <span class="keyword">int</span> humanfriendly)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Create a new module string from another RedisModuleString */</span></span><br><span class="line"><span class="function">RedisModuleString *<span class="title">RedisModule_CreateStringFromString</span><span class="params">(RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> RedisModuleString *str)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>在未启用自动内存管理功能时，上述接口所返回的对象必须调用 <code>RedisModule_FreeString()</code> 进行释放</li>
<li>当你想在上下文范围之外创建一个 <code>RedisModuleString</code> 对象时，<code>ctx</code> 可设置为 <code>NULL</code>，与此同时，自动内存管理功能不可用，你必须手动进行释放操作</li>
</ul>
<h3 id="free">Free</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Free a module string object obtained with one of the</span></span><br><span class="line"><span class="comment"> * Redis Module API calls that return new string objects. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_FreeString</span><span class="params">(RedisModuleCtx *ctx, RedisModuleString *str)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>在启用自动内存管理的情况下，我们仍然可以调用该函数，会立即释放传入的 <code>RedisModuleString</code></li>
<li>如果在创建 <code>RedisModuleString</code> 时上下文为 <code>NULL</code>，则在释放时上下文也可为 <code>NULL</code>，不过此时上下文不为 <code>NULL</code> 也没啥问题。但如果创建时上下文不为空，则在释放时也不可为空。</li>
</ul>
<h3 id="retain">Retain</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_RetainString</span><span class="params">(RedisModuleCtx *ctx, RedisModuleString *str)</span></span>;</span><br></pre></td></tr></table></figure>
<p>通常而言，只有在以下条件都满足时，才会调用这个函数：</p>
<ul>
<li>You have automatic memory management enabled</li>
<li>You want to create string objects</li>
<li>Those string objects you create need to live after the callback function creating them returns</li>
</ul>
<p>如果在未开启自动管理时，调用该函数，则额外需要再调用一次 <code>RedisModule_FreeString()</code> 以释放内存。在该函数中，上下文也可以为空。</p>
<h3 id="convert">Convert</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return the string pointer and length of the given module string.</span></span><br><span class="line"><span class="comment"> * Return value should only be used for read only access and never modified. */</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">RedisModule_StringPtrLen</span><span class="params">(<span class="keyword">const</span> RedisModuleString *str, <span class="keyword">size_t</span> *len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert the string into a long long integer, storing it at *ll.</span></span><br><span class="line"><span class="comment"> * Return REDISMODULE_OK on success. if the string can't be parsed as a valid,</span></span><br><span class="line"><span class="comment"> * strict long long(no sapces before/after), REDISMODULE_ERR is returned. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_StringToLongLong</span><span class="params">(<span class="keyword">const</span> RedisModuleString *str, <span class="keyword">long</span> <span class="keyword">long</span> *ll)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert the string into a double, storing it at *d.</span></span><br><span class="line"><span class="comment"> * Return REDISMODULE_OK on success or REDISMODULE_ERR</span></span><br><span class="line"><span class="comment"> * if the string is not a valid string representation of a double value. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_StringToDouble</span><span class="params">(<span class="keyword">const</span> RedisModuleString *str, <span class="keyword">double</span> *d)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert the string into a long double, storing it at *ld.</span></span><br><span class="line"><span class="comment"> * Return REDISMODULE_OK on success or REDISMODULE_ERR if the</span></span><br><span class="line"><span class="comment"> * string is not a valid string representation of a long double value. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_StringToLongDouble</span><span class="params">(<span class="keyword">const</span> RedisModuleString *str, <span class="keyword">long</span> <span class="keyword">double</span> *ld)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="operators">Operators</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Compare two string objects, returning -1, 0 or 1 respectively if a &lt; b,</span></span><br><span class="line"><span class="comment"> * a == b or a &gt; b. String are compared byte by byte as two binary blobs</span></span><br><span class="line"><span class="comment"> * without any encoding care/collation attempt. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_StringCompare</span><span class="params">(RedisModuleString *a, RedisModuleString *b)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Append the specified buffer to the string str. The string must be</span></span><br><span class="line"><span class="comment"> * a string created by the user that is referenced only a single time,</span></span><br><span class="line"><span class="comment"> * otherwise REDISMOUDLE_ERR is returned and the operation is not performed. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_StringAppendBuffer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleString *str,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> len)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="reply">Reply</h2>
<h3 id="other">Other</h3>
<p>以下函数返回值固定为 <code>REDISMODULE_OK</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Send an error about the number of arguments given to the command,</span></span><br><span class="line"><span class="comment"> * citing the command name in the error message. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_WrongArity</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reply to client with a NULL. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithNull</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reply with the error, that must contain all the error, include the</span></span><br><span class="line"><span class="comment"> * intial error code.  */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithError</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">const</span> <span class="keyword">char</span> *err)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reply exactly what a Redis command returned us with RedisModule_Call().</span></span><br><span class="line"><span class="comment"> * This function is useful when we use RedisModule_Call() in order to execute</span></span><br><span class="line"><span class="comment"> * some command, as we want to reply to the client exactly the same reply</span></span><br><span class="line"><span class="comment"> * we obtained by the command. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithCallReply</span><span class="params">(RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   RedisModuleCallReply *reply)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="number">Number</h3>
<p>以下函数返回值固定为 <code>REDISMODULE_OK</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Send an integer reply to the client, with the specified long long value. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithLongLong</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">long</span> <span class="keyword">long</span> ll)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Send a string reply obtained converting the double 'd' into a bulk string.</span></span><br><span class="line"><span class="comment"> * This function is basically equivalent to converting a double into a string</span></span><br><span class="line"><span class="comment"> * into a C buffer, and then calling the function</span></span><br><span class="line"><span class="comment"> * RedisModule_ReplyWithStringBuffer() with the buffer and length. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithDouble</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">double</span> d)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Send a string reply obtained converting the long double 'ld' into a bulk</span></span><br><span class="line"><span class="comment"> * string. This function is basically equivalent to converting a long double</span></span><br><span class="line"><span class="comment"> * into a string into a C buffer, and then calling the function</span></span><br><span class="line"><span class="comment"> * RedisModule_ReplyWithStringBuffer() with the buffer and length.</span></span><br><span class="line"><span class="comment"> * The double string uses human readable formatting</span></span><br><span class="line"><span class="comment"> * (see addReplyHumanLongDouble in networking.c). */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithLongDouble</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">long</span> <span class="keyword">double</span> ld)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="string">String</h3>
<p>以下函数返回值固定为 <code>REDISMODULE_OK</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Reply with a simple string(+...\r\n in RESP protocol). This replies are</span></span><br><span class="line"><span class="comment"> * suitable only when sending a small non-binary string with small overhead,</span></span><br><span class="line"><span class="comment"> * like "OK" or similar replies. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithSimpleString</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">const</span> <span class="keyword">char</span> *msg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reply with a bulk string, taking in input a C buffer pointer</span></span><br><span class="line"><span class="comment"> * that is assumed to be null-terminated. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithCString</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">const</span> <span class="keyword">char</span> *buf)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reply with a bulk string, taking in input a C buffer pointer and length. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithStringBuffer</span><span class="params">(RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reply with a bulk string, taking in input a RedisModuleString object. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithString</span><span class="params">(RedisModuleCtx *ctx, RedisModuleString *str)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reply with an empty string */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithEmptyString</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reply with a binary safe string, which should not be escaped or filtered</span></span><br><span class="line"><span class="comment"> * taking in input a C buffer pointer and length. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithVerbatimString</span><span class="params">(RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> len)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="array">Array</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Reply with an array type of len elements.</span></span><br><span class="line"><span class="comment"> * However len other calls to ReplyWith* style functions must follow in order to</span></span><br><span class="line"><span class="comment"> * emit the elements of the array. The function always returns REDISMODULE_OK. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithArray</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">long</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* When RedisModule_ReplyWithArray() is used with the argument</span></span><br><span class="line"><span class="comment"> * REDISMODULE_POSTPONED_ARRAY_LEN, because we don't know beforehand the number</span></span><br><span class="line"><span class="comment"> * of items we are going to output as elements of the array, this function will</span></span><br><span class="line"><span class="comment"> * take care to set the array length.</span></span><br><span class="line"><span class="comment"> * Since it is possible to have multiple array replies pending with unknown</span></span><br><span class="line"><span class="comment"> * length, this function guarantees to always set the latest array length</span></span><br><span class="line"><span class="comment"> * that was created in a postponed way. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_ReplySetArrayLength</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">long</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reply to the client with a null array, simple null in RESP3</span></span><br><span class="line"><span class="comment"> * null array in RESP2. The function always returns REDISMODULE_OK. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithNullArray</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reply to client with an empty array.</span></span><br><span class="line"><span class="comment"> * The function always returns REDISMODULE_OK. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplyWithEmptyArray</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="control-command">Control command</h2>
<p><strong>GetClientId</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return th ID of the current client calling the currently active module cmd. */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">RedisModule_GetClientId</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>每个客户端 ID 是唯一的，单调递增的，取值范围为 <span class="math inline">\([1, 2^{64} - 1]\)</span></li>
<li>返回 0 则意味着在当前上下文中无法获取客户端 ID</li>
</ul>
<p><strong>GetClientInfoById</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return information about the client with the specified ID. If the client</span></span><br><span class="line"><span class="comment"> * exists, REDISMODULE_OK is returned, otherwise REDISMODULE_ERR is returned. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_GetClientInfoById</span><span class="params">(<span class="keyword">void</span> *ci, <span class="keyword">uint64_t</span> id)</span></span>;</span><br></pre></td></tr></table></figure>
<p>当 <code>ci</code> 不为 <code>NULL</code> 时，其指向一个 <code>RedisModuleClientInfo</code> 结构体，该结构体可被 <code>REDISMODULE_CLIENTINFO_INITIALIZER</code> 初始化，其包含以下成员：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> flags;     <span class="comment">// REDISMODULE_CLIENTINFO_FLAG_*</span></span><br><span class="line"><span class="keyword">uint64_t</span> id;        <span class="comment">// Client ID</span></span><br><span class="line"><span class="keyword">char</span> addr[<span class="number">46</span>];      <span class="comment">// IPv4 or IPv6 address</span></span><br><span class="line"><span class="keyword">uint16_t</span> port;      <span class="comment">// TCP port</span></span><br><span class="line"><span class="keyword">uint16_t</span> db;        <span class="comment">// Selected DB</span></span><br></pre></td></tr></table></figure>
<p>其中 <code>flags</code> 的种类如下：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">flag</th>
<th style="text-align: left;">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">REDISMODULE_CLIENTINFO_FLAG_SSL</td>
<td style="text-align: left;">Client using SSL connection.</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULE_CLIENTINFO_FLAG_PUBSUB</td>
<td style="text-align: left;">Client in Pub/Sub mode.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULE_CLIENTINFO_FLAG_BLOCKED</td>
<td style="text-align: left;">Client blocked in command.</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULE_CLIENTINFO_FLAG_TRACKING</td>
<td style="text-align: left;">Client with keys tracking on.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULE_CLIENTINFO_FLAG_UNIXSOCKET</td>
<td style="text-align: left;">Client using unix domain socket.</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULE_CLIENTINFO_FLAG_MULTI</td>
<td style="text-align: left;">Client in MULTI state.</td>
</tr>
</tbody>
</table>
<p><strong>PublishMessage</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Publish a message to subscribers (see PUBLISH command). */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_PublishMessage</span><span class="params">(RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleString *channel, RedisModuleString *message)</span></span>;</span><br></pre></td></tr></table></figure>
<p><strong>GetSelectedDb</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return the currently selected DB. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_GetSelectedDb</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br></pre></td></tr></table></figure>
<p><strong>SelectDb</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Change the currently selected DB. Returns an error if the id is out of range. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_SelectDb</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">int</span> newid)</span></span>;</span><br></pre></td></tr></table></figure>
<p>若调用该函数，直接返回响应后，客户端会一直保留该函数执行后所选择的 <code>DB</code>。因此，如想切换回之前的 <code>DB</code>，可调用 <code>RedisModule_GetSelectedDb()</code> 保存之前的 <code>DB</code>，并在返回响应前，切换回原先的 <code>DB</code>。</p>
<p><strong>DbSize</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Returns the number of keys in the current db. */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">RedisModule_DbSize</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br></pre></td></tr></table></figure>
<p><strong>ResetDataset</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_ResetDataset</span><span class="params">(<span class="keyword">int</span> restart_aof, <span class="keyword">int</span> async)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行与 <code>FLUSHALL</code> 类似的操作</li>
<li>在启用 <code>AOF</code> 的情况下，如果 <code>restart_aof</code> 为 <code>true</code>，则会启动一个新的 <code>AOF</code> 文件，必须确保该命令不会传播到新的 <code>AOF</code> 文件</li>
<li>如果 <code>async</code> 设置为 <code>true</code>，则释放数据占用内存的操作会在后台线程中执行</li>
</ul>
<p><strong>GetContextFlags</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return the current context's flags. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_GetContextFlags</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>上下文标志会包含当前请求信息和实例信息</li>
<li>也可以对 <code>NULL</code> 上下文调用该函数</li>
</ul>
<p>其中 <code>flags</code> 的种类如下：</p>
<table>
<colgroup>
<col style="width: 53%">
<col style="width: 46%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">flag</th>
<th style="text-align: left;">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">REDISMODULECTXFLAGS_LUA</td>
<td style="text-align: left;">The command is running in a Lua script</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULECTXFLAGS_MULTI</td>
<td style="text-align: left;">The command is running inside a transaction</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULECTXFLAGS_REPLICATED</td>
<td style="text-align: left;">The command was sent over the replication link by the MASTER</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULECTXFLAGS_MASTER</td>
<td style="text-align: left;">The Redis instance is a master</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULECTXFLAGS_SLAVE</td>
<td style="text-align: left;">The Redis instance is a slave</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULECTXFLAGS_READONLY</td>
<td style="text-align: left;">The Redis instance is read-only</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULECTXFLAGS_CLUSTER</td>
<td style="text-align: left;">The Redis instance is in cluster mode</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULECTXFLAGS_AOF</td>
<td style="text-align: left;">The Redis instance has AOF enabled</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULECTXFLAGS_RDB</td>
<td style="text-align: left;">The instance has RDB enabled</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULECTXFLAGS_MAXMEMORY</td>
<td style="text-align: left;">The instance has Maxmemory set</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULECTXFLAGS_EVICT</td>
<td style="text-align: left;">Maxmemory is set and has an eviction policy that may delete keys</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULECTXFLAGS_OOM</td>
<td style="text-align: left;">Redis is out of memory according to the maxmemory setting.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULECTXFLAGSOOMWARNING</td>
<td style="text-align: left;">Less than 25% of memory remains before reaching the maxmemory level.</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULECTXFLAGS_LOADING</td>
<td style="text-align: left;">Server is loading RDB/AOF</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULECTXFLAGSREPLICAIS_STALE</td>
<td style="text-align: left;">No active link with the master.</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULECTXFLAGSREPLICAIS_CONNECTING</td>
<td style="text-align: left;">The replica is trying to connect with the master.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULECTXFLAGSREPLICAIS_TRANSFERRING</td>
<td style="text-align: left;">Master -&gt; Replica RDB transfer is in progress.</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULECTXFLAGSREPLICAIS_ONLINE</td>
<td style="text-align: left;">The replica has an active link with its master. This is the contrary of STALE state.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULECTXFLAGSACTIVECHILD</td>
<td style="text-align: left;">There is currently some background process active (RDB, AUX or module).</td>
</tr>
</tbody>
</table>
<h2 id="low-level-key-apis">Low level Key APIs</h2>
<h3 id="base">Base</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return an handle representing a Redis key, so that it is possible to call</span></span><br><span class="line"><span class="comment"> * other APIs with the key handle as argument to perform operations on the key. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">RedisModule_OpenKey</span><span class="params">(RedisModuleCtx *ctx, robj *keyname, <span class="keyword">int</span> mode)</span></span>;</span><br></pre></td></tr></table></figure>
<p>通过 <code>RedisModule_OpenKey()</code> 返回的 <code>RedisModuleKey</code>，在对其访问结束之前，必须调用 <code>RedisModule_CloseKey()</code> 以释放句柄。</p>
<p>调用 <code>RedisModule_OpenKey()</code> 传入的 key 不存在时：</p>
<ul>
<li>如果是 <code>REDISMODULE_WRITE</code> 模式，仍会返回句柄</li>
<li>如果仅是 <code>REDISMODULE_READ</code> 模式，则会返回 <code>NULL</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Close a key handle. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_CloseKey</span><span class="params">(RedisModuleKey *key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the type of the key. If the key pointer is NULL then</span></span><br><span class="line"><span class="comment"> * REDISMODULE_KEYTYPE_EMPTY is returned. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_KeyType</span><span class="params">(RedisModuleKey *key)</span></span>;</span><br></pre></td></tr></table></figure>
<p>调用 <code>RedisModule_CloseKey()</code> 或 <code>RedisModule_KeyType()</code> 时，传入的实参可以为 <code>NULL</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return the length of the value associated with the key.</span></span><br><span class="line"><span class="comment"> * For strings this is the length of the string.</span></span><br><span class="line"><span class="comment"> * For all the other types is the number of elements (just counting keys for hashes).</span></span><br><span class="line"><span class="comment"> * If the key pointer is NULL or the key is empty, zero is returned.*/</span></span><br><span class="line"><span class="keyword">size_t</span> RedisModule_ValueLength(RedisModuleKey *key);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If the key is open for writing, remove it, and setup the key to accept</span></span><br><span class="line"><span class="comment"> * new writes as an empty key (that will be created on demand).</span></span><br><span class="line"><span class="comment"> * On success REDISMODULE_OK is returned. If the key is not open for writing</span></span><br><span class="line"><span class="comment"> * REDISMODULE_ERR is returned. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_DeleteKey</span><span class="params">(RedisModuleKey *key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If the key is open for writing, unlink it (that is delete it in a</span></span><br><span class="line"><span class="comment"> * non-blocking way, not reclaiming memory immediately) and setup the key</span></span><br><span class="line"><span class="comment"> * to accept new writes as an empty key (that will be created on demand).</span></span><br><span class="line"><span class="comment"> * On success REDISMODULE_OK is returned. If the key is not open for writing</span></span><br><span class="line"><span class="comment"> * REDISMODULE_ERR is returned. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_UnlinkKey</span><span class="params">(RedisModuleKey *key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the key expire value, as milliseconds of remaining TTL.</span></span><br><span class="line"><span class="comment"> * If no TTL is associated with the key or if the key is empty,</span></span><br><span class="line"><span class="comment"> * REDISMODULE_NO_EXPIRE is returned. */</span></span><br><span class="line"><span class="keyword">mstime_t</span> RedisModule_GetExpire(RedisModuleKey *key);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set a new expire for the key.</span></span><br><span class="line"><span class="comment"> * If the special expire REDISMODULE_NO_EXPIRE is set,</span></span><br><span class="line"><span class="comment"> * the expire is cancelled if there was one (the same as the PERSIST command).</span></span><br><span class="line"><span class="comment"> * The function returns REDISMODULE_OK on success or</span></span><br><span class="line"><span class="comment"> * REDISMODULE_ERR if the key was not open for writing or is an empty key. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_SetExpire</span><span class="params">(RedisModuleKey *key, <span class="keyword">mstime_t</span> expire)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns a name of a random key, or NULL if current db is empty. */</span></span><br><span class="line"><span class="function">RedisModuleString *<span class="title">RedisModule_RandomKey</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="string-1">String</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* If the key is open for writing, set the specified string 'str' as the value</span></span><br><span class="line"><span class="comment"> * of the key, deleting the old value if any.</span></span><br><span class="line"><span class="comment"> * On success REDISMODULE_OK is returned. If the key is not open for writing</span></span><br><span class="line"><span class="comment"> * or there is an active iterator, REDISMODULE_ERR is returned. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_StringSet</span><span class="params">(RedisModuleKey *key, RedisModuleString *str)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If the string is open for writing and is of string type, resize it,</span></span><br><span class="line"><span class="comment"> * padding with zero bytes if the new length is greater than the old one.</span></span><br><span class="line"><span class="comment"> * If the key is empty, a string key is created with the new string value</span></span><br><span class="line"><span class="comment"> * unless the new length value requested is zero.</span></span><br><span class="line"><span class="comment"> * The function returns REDISMODULE_OK on success, and REDISMODULE_ERR on error,</span></span><br><span class="line"><span class="comment"> * that is, the key is not open for writing, is not a string or resizing for</span></span><br><span class="line"><span class="comment"> * more than 512 MB is requested. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_StringTruncate</span><span class="params">(RedisModuleKey *key, <span class="keyword">size_t</span> newlen)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Prepare the key associated string value for DMA access, and returns</span></span><br><span class="line"><span class="comment"> * a pointer and size (by reference), that the user can use to read or</span></span><br><span class="line"><span class="comment"> * modify the string in-place accessing it directly via pointer. */</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">RedisModule_StringDMA</span><span class="params">(RedisModuleKey *key, <span class="keyword">size_t</span> *len, <span class="keyword">int</span> mode)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 <code>key</code> 所关联的对象不是 <code>String</code> 类型，则会返回 error</li>
<li>如果 <code>mode</code> 仅为可读，则不该修改返回值</li>
<li>DMA access rules:
<ul>
<li>No other key writing function should be called since the moment the pointer is obtained, for all the time we want to use DMA access to read or modify the string.</li>
<li>Each time <code>RedisModule_StringTruncate()</code> is called, to continue with the DMA access, <code>RedisModule_StringDMA()</code> should be called again to re-obtain a new pointer and length.</li>
<li>If the returned pointer is not NULL, but the length is zero, no byte can be touched (the string is empty, or the key itself is empty) so a <code>RedisModule_StringTruncate()</code> call should be used if there is to enlarge the string, and later call <code>RedisModule_StringDMA()</code> again to get the pointer.</li>
</ul></li>
</ul>
<h3 id="list">List</h3>
<p><strong>Push</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Push an element into a list, on head or tail depending on 'where' argument. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ListPush</span><span class="params">(RedisModuleKey *key, <span class="keyword">int</span> where, RedisModuleString *ele)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果传入的 <code>key</code> 为空，模式为写模式的话，则会创建新 <code>key</code></li>
<li>只读模式或类型错误，返回 <code>REDISMODULE_ERR</code>，否则返回 <code>REDISMODULE_OK</code></li>
</ul>
<p><strong>Pop</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Pop an element from list, from head or tail depending on 'where' argument. */</span></span><br><span class="line"><span class="function">RedisModuleString *<span class="title">RedisModule_ListPop</span><span class="params">(RedisModuleKey *key, <span class="keyword">int</span> where)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>在未启用自动内存管理的情况下，返回值必须调用 <code>RedisModule_FreeString()</code> 进行释放</li>
<li>返回值为 <code>NULL</code> 时，可能由以下原因造成：
<ul>
<li>列表为空</li>
<li>只读模式</li>
<li>类型错误</li>
</ul></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* tail and head */</span></span><br><span class="line">REDISMODULE_LIST_HEAD</span><br><span class="line">REDISMODULE_LIST_TAIL</span><br></pre></td></tr></table></figure>
<h3 id="zset">ZSET</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Conversion from/to public flags of the Modules API and our private flags,</span></span><br><span class="line"><span class="comment"> * so that we have everything decoupled. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetAddFlagsToCoreFlags</span><span class="params">(<span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetAddFlagsFromCoreFlags</span><span class="params">(<span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
<p><strong>ZADD</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Add a new element into a sorted set, with the specified 'score'.</span></span><br><span class="line"><span class="comment"> * If the element already exists, the score is updated. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetAdd</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleKey *key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">double</span> score,</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleString *ele,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> *flagsptr)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在写模式下，如果 <code>key</code> 为空，则会新建一个 <code>ZSET</code>。</p>
<p>可以注意到，此处 flags 按指针传递，其用途有二：</p>
<ul>
<li>作为 <code>input flags</code>， 决定 <code>RedisModule_ZsetAdd()</code> 的行为模式</li>
<li>作为 <code>output flags</code>，返回 <code>RedisModule_ZsetAdd()</code> 的执行结果</li>
</ul>
<p>其中，<code>input flags</code> 可以为</p>
<ul>
<li><code>REDISMODULE_ZADD_XX</code>: Element must already exist. Do nothing otherwise.</li>
<li><code>REDISMODULE_ZADD_NX</code>: Element must not exist. Do nothing otherwise.</li>
</ul>
<p><code>output flags</code> 可以为：</p>
<ul>
<li><code>REDISMODULE_ZADD_ADDED</code>: The new element was added to the sorted set.</li>
<li><code>REDISMODULE_ZADD_UPDATED</code>: The score of the element was updated.</li>
<li><code>REDISMODULE_ZADD_NOP</code>: No operation was performed because XX or NX flags.</li>
</ul>
<p>当然，<code>flagsptr</code> 也可为 <code>NULL</code>。</p>
<p>函数执行成功时返回 <code>REDISMODULE_OK</code>，但遇到以下错误时会返回 <code>REDISMODULE_ERR</code>:</p>
<ul>
<li>只读模式</li>
<li>类型错误</li>
<li>传入的 <code>score</code> 不是数值类型</li>
</ul>
<p><strong>ZINCRBY</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Increase the score of the existing element, of if the element does not</span></span><br><span class="line"><span class="comment"> * already exist, it is added assuming the old score was zero. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetIncrby</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleKey *key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">double</span> score,</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleString *ele,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> *flagsptr,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">double</span> *newscore)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>inpout/output flags</code> 和返回值和 <code>RedisModule_ZsetAdd()</code> 一样，唯一的区别是，当 <code>score</code> 不是数值类型时，该函数除了返回 <code>REDISMODULE_ERR</code> 之外，还会使得现有 <code>element</code> 的 <code>socre</code> 变成非数值类型。</p>
<p>传入的 <code>newscore</code> 实参不为 <code>NULL</code> 时，会在函数执行完毕之后使用 <code>element</code> 新的 <code>score</code> 进行填充，在无错误的情况下，会被返回。</p>
<p><strong>ZREM</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Remove the specified element from the sorted set. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetRem</span><span class="params">(RedisModuleKey *key, RedisModuleString *ele, <span class="keyword">int</span> *deleted)</span></span>;</span><br></pre></td></tr></table></figure>
<p>函数执行成功时返回 <code>REDISMODULE_OK</code>，但遇到以下错误时会返回 <code>REDISMODULE_ERR</code>:</p>
<ul>
<li>只读模式</li>
<li>类型错误</li>
</ul>
<p>通过返回值不能确定该 <code>element</code> 是否真的被移除，如果想知道 <code>element</code> 是否被移除的话，则需要传入非空的 <code>deleted</code> 指针，其在返回时会根据额函数执行情况填充 0 或 1</p>
<p><strong>ZSCORE</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Retrieve the double score associated at the sorted set element 'ele'. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetScore</span><span class="params">(RedisModuleKey *key, RedisModuleString *ele, <span class="keyword">double</span> *score)</span></span>;</span><br></pre></td></tr></table></figure>
<p>函数执行成功时返回 <code>REDISMODULE_OK</code>，但遇到以下错误时会返回 <code>REDISMODULE_ERR</code>:</p>
<ul>
<li>该 <code>ZSET</code> 中不存在该 <code>element</code></li>
<li><code>key</code> 为空</li>
<li>类型错误</li>
</ul>
<p><strong>ZRANGE</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Stop a sorted set iteration. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_ZsetRangeStop</span><span class="params">(RedisModuleKey *key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the "End of range" flag value to signal the end of the iteration. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetRangeEndReached</span><span class="params">(RedisModuleKey *key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the current sorted set element of an active sorted set iterator or</span></span><br><span class="line"><span class="comment"> * NULL if the range specified in the iterator does not include any element. */</span></span><br><span class="line"><span class="function">RedisModuleString *<span class="title">RedisModule_ZsetRangeCurrentElement</span><span class="params">(RedisModuleKey *key, <span class="keyword">double</span> *score)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Go to the next element of the sorted set iterator.</span></span><br><span class="line"><span class="comment"> * Returns 1 if there was a next element, 0 if we are already</span></span><br><span class="line"><span class="comment"> * at the latest element or the range does not include any item at all. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetRangeNext</span><span class="params">(RedisModuleKey *key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Go to the previous element of the sorted set iterator.</span></span><br><span class="line"><span class="comment"> * Returns 1 if there was a previous element, 0 if we are already</span></span><br><span class="line"><span class="comment"> * at the first element or the range does not include any item at all. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetRangePrev</span><span class="params">(RedisModuleKey *key)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Setup a sorted set iterator seeking the first element in the specified range. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetFirstInScoreRange</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleKey *key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">double</span> min, <span class="keyword">double</span> max,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> minex, <span class="keyword">int</span> maxex)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Exactly like RedisModule_ZsetFirstInScoreRange() but the last element of</span></span><br><span class="line"><span class="comment"> * the range is selected for the start of the iteration instead. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetLastInScoreRange</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleKey *key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">double</span> min, <span class="keyword">double</span> max,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> minex, <span class="keyword">int</span> maxex)</span></span>;</span><br></pre></td></tr></table></figure>
<p>上述两函数在迭代器被正确初始化时，返回 <code>REDISMODULE_OK</code>；在 <code>key</code> 为空或对应的数据类型不是 <code>ZSET</code> 时，返回 <code>REDISMODULE_ERR</code>。</p>
<p>迭代区间由 <code>min</code> 和 <code>max</code> 控制，当 <code>minex</code>(<code>maxex</code>) 设置为 <code>true</code> 时，区间不包含 <code>min</code>(<code>max</code>)。可以使用以下宏赋值给 <code>min</code> 或 <code>max</code>:</p>
<ul>
<li><code>REDISMODULE_POSITIVE_INFINITE</code>: positive infinite value</li>
<li><code>REDISMODULE_NEGATIVE_INFINITE</code>: negative infinite value</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Setup a sorted set iterator seeking the first element in the</span></span><br><span class="line"><span class="comment"> * specified lexicographical range. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetFirstInLexRange</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleKey *key,</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleString *min, RedisModuleString *max)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Exactly like RedisModule_ZsetFirstInLexRange() but the last element</span></span><br><span class="line"><span class="comment"> * of the range is selected for the start of the iteration instead. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ZsetLastInLexRange</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleKey *key,</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleString *min, RedisModuleString *max)</span></span>;</span><br></pre></td></tr></table></figure>
<p>上述两函数在迭代器被正确初始化时，返回 <code>REDISMODULE_OK</code>，在以下情况下返回 <code>REDISMODULE_ERR</code>:</p>
<ul>
<li><code>key</code> 对应的数据类型不为 <code>ZSET</code></li>
<li><code>key</code> 为空</li>
<li>确定字典范围的 <code>min</code> 和 <code>max</code> 格式错误</li>
</ul>
<p>传入的 <code>min</code> 和 <code>max</code> 格式和 <code>ZRANGEBYLEX</code> 命令参数的格式相同。<code>min</code> 和 <code>max</code> 对象可在迭代器被正确赋值之后立即释放。</p>
<h3 id="hash">Hash</h3>
<p><strong>HashSet</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Set the field of the specified hash field to the specified value. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_HashSet</span><span class="params">(RedisModuleKey *key, <span class="keyword">int</span> flags, ...)</span></span>;</span><br></pre></td></tr></table></figure>
<p>如果 <code>key</code> 为空且处于写模式，则会新建一个 <code>Hash</code>。</p>
<p>控制函数行为模式的 <code>flags</code> 列表如下：</p>
<table>
<colgroup>
<col style="width: 32%">
<col style="width: 67%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">flags</th>
<th style="text-align: left;">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">REDISMODULE_HASH_NONE</td>
<td style="text-align: left;">No special behavior is needed.</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULE_HASH_NX</td>
<td style="text-align: left;">The operation is performed only if the field was not already existing in the hash.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULE_HASH_XX</td>
<td style="text-align: left;">The operation is performed only if the field was already existing, so that a new value could be associated to an existing filed, but no new fields are created.</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULE_HASH_CFIELDS</td>
<td style="text-align: left;">The field names passed are null terminated C strings instead of RedisModuleString objects.</td>
</tr>
</tbody>
</table>
<p>可变参数列表由 <code>flied/value-ptr pairs</code> 和 <code>NULL</code> 组成：</p>
<ul>
<li><code>flied/value-ptr pairs</code> 中传入的数据类型为 <code>RedisModuleString*</code> (flags 不为 CFIELDS)</li>
<li><code>NULL</code> 为最后一个实参的标识</li>
<li>当 <code>value == REDISMODULE_HASH_DELETE</code> 时，意为删除对应的 <code>field</code></li>
</ul>
<p>该函数的返回值为更新的 <code>field</code> 个数，<code>key</code> 为只读模式或对应的数据类型不为 <code>Hash</code> 时，返回值一直为 0。</p>
<p><strong>HashGet</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Get field value */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_HashGet</span><span class="params">(RedisModuleKey *key, <span class="keyword">int</span> flags, ...)</span></span>;</span><br></pre></td></tr></table></figure>
<p>控制函数行为模式的 <code>flags</code> 列表如下：</p>
<table>
<colgroup>
<col style="width: 30%">
<col style="width: 69%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">flags</th>
<th style="text-align: left;">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">REDISMODULE_HASH_NONE</td>
<td style="text-align: left;">No special behavior is needed.</td>
</tr>
<tr class="even">
<td style="text-align: left;">REDISMODULE_HASH_CFIELD</td>
<td style="text-align: left;">field names as null terminated C strings.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">REDISMODULE_HASH_EXISTS</td>
<td style="text-align: left;">instead of setting the value of the field expecting a RedisModuleString pointer to pointer, the function just reports if the field exists or not and expects an integer pointer as the second element of each pair.</td>
</tr>
</tbody>
</table>
<p>可变参数列表由 <code>flied/value-ptr pairs</code> 和 <code>NULL</code> 组成：</p>
<ul>
<li><code>flied/value-ptr pairs</code> 中传入的数据类型为 <code>RedisModuleString*</code> (flags 不为 CFIELDS)</li>
<li><code>NULL</code> 为最后一个实参的标识</li>
<li>返回时，<code>value</code> 指针为空表示对应的 <code>field</code> 不存在</li>
<li>不要忘记释放 <code>RedisModuleString</code> 对象</li>
</ul>
<p>在函数执行成功时返回 <code>REDISMODULE_OK</code>，如 <code>key</code> 对应的数据类型不为 <code>Hash</code>，则返回 <code>REDISMODULE_ERR</code>。</p>
<h2 id="high-level-key-apis">High level Key APIs</h2>
<p><strong>Call</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Exported API to call any Redis command from modules. */</span></span><br><span class="line"><span class="function">RedisModuleCallReply *<span class="title">RedisModule_Call</span><span class="params">( RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">char</span> *cmdname, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br></pre></td></tr></table></figure>
<p>格式说明符列表如下：</p>
<ul>
<li><code>c</code> -- Null terminated C string pointer</li>
<li><code>b</code> -- C buffer, two arguments needed: C string pointer and <code>size_t</code> length</li>
<li><code>s</code> -- RedisModuleString as received in <code>argv</code> or by other Redis module APIs returning a RedisModuleString object</li>
<li><code>l</code> -- Long long integer</li>
<li><code>v</code> -- Array of RedisModuleString objects</li>
<li><code>!</code> -- This modifier just tells the function to replicate the command to replicas and AOF. it is ignored from the point of view of arguments parsing</li>
<li><code>A</code> -- This modifier, when <code>!</code> is given, tells to suppress AOF propagation: the command will propagated only to replicas</li>
<li><code>R</code> -- This modifier, when <code>!</code> is given, tells to suppress replicas propagation: the command will be propagated only to the AOF if enabled</li>
</ul>
<p>函数执行成功时返回 <code>RedisModuleCallReply</code> 对象，失败时返回 <code>NULL</code> 并将 <code>errno</code> 设置为以下值：</p>
<table>
<colgroup>
<col style="width: 11%">
<col style="width: 88%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">errno</th>
<th style="text-align: left;">meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">EBADF</td>
<td style="text-align: left;">wrong format specifier.</td>
</tr>
<tr class="even">
<td style="text-align: left;">EINVAL</td>
<td style="text-align: left;">wrong command arity.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ENOENT</td>
<td style="text-align: left;">command does not exist.</td>
</tr>
<tr class="even">
<td style="text-align: left;">EPERM</td>
<td style="text-align: left;">operation in Cluster instance with key in non local slot.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">EROFS</td>
<td style="text-align: left;">operation in Cluster instance when a write command is sent in a readonly state. ENETDOWN</td>
</tr>
</tbody>
</table>
<p><strong>Access CallReply</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return the reply type. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_CallReplyType</span><span class="params">(RedisModuleCallReply *reply)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the reply type length, where applicable. */</span></span><br><span class="line"><span class="keyword">size_t</span> RedisModule_CallReplyLength(RedisModuleCallReply *reply);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the 'idx'-th nested call reply element of an array reply,</span></span><br><span class="line"><span class="comment"> * or NULL if the reply type is wrong or the index is out of range. */</span></span><br><span class="line"><span class="function">RedisModuleCallReply *<span class="title">RedisModule_CallReplyArrayElement</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleCallReply *reply, <span class="keyword">size_t</span> idx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the long long of an integer reply. */</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">RedisModule_CallReplyInteger</span><span class="params">(RedisModuleCallReply *reply)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the pointer and length of a string or error reply. */</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">RedisModule_CallReplyStringPtr</span><span class="params">(RedisModuleCallReply *reply, <span class="keyword">size_t</span> *len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return a new string object from a call reply of type string,</span></span><br><span class="line"><span class="comment"> * error or integer. Otherwise (wrong reply type) return NULL. */</span></span><br><span class="line"><span class="function">RedisModuleString *<span class="title">RedisModule_CreateStringFromCallReply</span><span class="params">(RedisModuleCallReply *reply)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return a pointer, and a length, to the protocol</span></span><br><span class="line"><span class="comment"> * returned by the command that returned the reply object. */</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">RedisModule_CallReplyProto</span><span class="params">(RedisModuleCallReply *reply, <span class="keyword">size_t</span> *len)</span></span>;</span><br></pre></td></tr></table></figure>
<p><strong>Free CallReply</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Free a Call reply and all the nested replies it contains if it's an array. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_FreeCallReply_Rec</span><span class="params">(RedisModuleCallReply *reply, <span class="keyword">int</span> freenested)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Wrapper for the recursive free reply function.</span></span><br><span class="line"><span class="comment"> * This is needed in order to have the first level function to return</span></span><br><span class="line"><span class="comment"> * on nested replies, but only if called by the module API. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_FreeCallReply</span><span class="params">(RedisModuleCallReply *reply)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="register-a-new-command-in-the-redis-server">Register a new command in the Redis server</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return REDISMODULE_ERR if the specified command name is already busy or</span></span><br><span class="line"><span class="comment"> * a set of invalid flags were passed, otherwise REDISMODULE_OK is returned</span></span><br><span class="line"><span class="comment"> * and the new command is registered. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_CreateCommand</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">char</span> *name,</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleCmdFunc cmdfunc,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">char</span> *strflags,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> firstkey,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> lastkey,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> keystep)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The command function type is the following,</span></span><br><span class="line"><span class="comment"> * and is supposed to always return REDIMODULE_OK. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MyCmd_RedisCommand</span><span class="params">(RedisModuleCtx *ctx, RedisModuleString **argv, <span class="keyword">int</span> argc)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>RedisModule_CreateCommand()</code> 必须在 <code>RedisModule_Onload()</code> 中调用.</p>
<p><code>strflags</code> 列表如下，如要传递多个 flags，则以空格隔开.</p>
<ul>
<li><code>write</code>: The command may modify the data set(it may also read from it)</li>
<li><code>readonly</code>: The command returns data from keys but never writes</li>
<li><code>admin</code>: The command is an administrative command (may change replication or perform similar tasks).</li>
<li><code>deny-oom</code>: The command may use additional memory and should be denied during out of memory conditions.</li>
<li><code>deny-script</code>: Don't allow this command in Lua scripts.</li>
<li><code>allow-loading</code>: Allow this command while the server is loading data. Only commands not interacting with the data set should be allowed to run in this mode. If not sure don't use this flag.</li>
<li><code>pubsub</code>: The command publishes things on Pub/Sub channels.</li>
<li><code>random</code>: The command may have different outputs even starting from the same input arguments and key values.</li>
<li><code>allow-stale</code>: The command is allowed to run on slaves that don't serve stale data. Don't use if you don't know what this means.</li>
<li><code>no-monitor</code>: Don't propagate the command on monitor. Use this if the command has sensible data among the arguments.</li>
<li><code>no-slowlog</code>: Don't log this command in the slowlog. Use this if the command has sensible data among the arguments.</li>
<li><code>fast</code>: The command time complexity is not greater than O(log(N)) where N is the size of the collection or anything else representing the normal scalability issue with the command.</li>
<li><code>getkeys-api</code>: The command implements the interface to return the arguments that are keys. Used when start/stop/step is not enough because of the command syntax.</li>
<li><code>no-cluster</code>: The command should not register in Redis Cluster since is not designed to work with it because, for example, is unable to report the position of the keys, programmatically creates key names, or any other reason.</li>
<li><code>no-auth</code>: This command can be run by an un-authenticated client. Normally this is used by a command that is used to authenticate a client.</li>
</ul>
<h2 id="自定义数据类型">自定义数据类型</h2>
<h3 id="register-a-new-data-type-exported-by-the-module">Register a new data type exported by the module</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">moduleType *<span class="title">RedisModule_CreateDataType</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">char</span> *name,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> encver,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span> *typemethods_ptr)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在 <code>name</code> 已存在，<code>name</code> 或 <code>encver</code> 非法的情况下，该函数返回 <code>NULL</code>。</p>
<p>各个参数说明如下：</p>
<ul>
<li><p><code>name</code>: 类型名，由 9 个字符组成，可用字符集合为 <code>{A-Z, a-z, 0-9, -, _}</code> &gt;"AAAAAAAAA" is reserved and produces an error</p></li>
<li><p><code>encver</code>: 序列化数据的 Encoding version，用于向前兼容，取值范围为 <span class="math inline">\([0, 1023]\)</span></p></li>
<li><p><code>typemethods_ptr</code>: 指向 <code>RedisModuleTypeMethods</code> 结构体的指针，示例如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">RedisModuleTypeMethods tm =</span><br><span class="line">&#123;</span><br><span class="line">    .version = REDISMODULE_TYPE_METHOD_VERSION,</span><br><span class="line">    .rdb_load = myType_RDBLoadCallBack,</span><br><span class="line">    .rdb_save = myType_RDBSaveCallBack,</span><br><span class="line">    .aof_rewrite = myType_AOFRewriteCallBack,</span><br><span class="line">    .<span class="built_in">free</span> = myType_FreeCallBack,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Optional fields */</span></span><br><span class="line">    .digest = myType_DigestCallBack,</span><br><span class="line">    .mem_usage = myType_MemUsageCallBack,</span><br><span class="line">    .aux_save = myType_AuxRDBSaveCallBack,</span><br><span class="line">    .aux_load = myType_AuxRDBLoadCallBack,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>结构体成员说明如下：</p>
<ul>
<li><code>rdb_load</code>: A callback function pointer that loads data from RDB files.</li>
<li><code>rdb_save</code>: A callback function pointer that saves data to RDB files.</li>
<li><code>aof_rewrite</code>: A callback function pointer that rewrites data as commands.</li>
<li><code>free</code>: A callback function pointer that can free a type value.</li>
<li><code>digest</code>: A callback function pointer that is used for <code>DEBUG DIGEST</code>.</li>
<li><code>mem_usage</code>: A callback function pointer that is used for <code>MEMORY</code></li>
<li><code>aux_save</code>: A callback function pointer that saves out of keyspace data to RDB files. <code>when</code> argument is either <code>REDISMODULE_AUX_BEFORE_RDB</code> or <code>REDISMODULE_AUX_AFTER_RDB</code>.</li>
<li><code>aux_load</code>: A callback function pointer that loads out of keyspace data from RDB files. Similar to <code>aux_save</code>, returns <code>REDISMODULE_OK</code> on success, and <code>REDISMODULE_ERR</code> otherwise.</li>
</ul>
<blockquote>
<p>The <code>digest</code> and <code>mem_usage</code> methods should currently be omitted since they are not yet implemented inside the Redis modules core.</p>
</blockquote></li>
</ul>
<h3 id="access-to-moduletype">Access to moduleType</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* If the key is open for writing, set the specified module type object</span></span><br><span class="line"><span class="comment"> * as the value of the key, deleting the old value if any.</span></span><br><span class="line"><span class="comment"> * On success REDISMODULE_OK is returned. If the key is not open for writing</span></span><br><span class="line"><span class="comment"> * or there is an active iterator, REDISMODULE_ERR is returned. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ModuleTypeSetValue</span><span class="params">(RedisModuleKey *key, moduleType *mt, <span class="keyword">void</span> *value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Assuming RedisModule_KeyType() returned REDISMODULE_KEYTYPE_MODULE on</span></span><br><span class="line"><span class="comment"> * the key, returns the module type pointer of the value stored at key.</span></span><br><span class="line"><span class="comment"> * If the key is NULL, is not associated with a module type, or is empty,</span></span><br><span class="line"><span class="comment"> * then NULL is returned instead. */</span></span><br><span class="line"><span class="function">moduleType *<span class="title">RedisModule_ModuleTypeGetType</span><span class="params">(RedisModuleKey *key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Assuming RedisModule_KeyType() returned REDISMODULE_KEYTYPE_MODULE on</span></span><br><span class="line"><span class="comment"> * the key, returns the module type low-level value stored at key, as</span></span><br><span class="line"><span class="comment"> * it was set by the user via RedisModule_ModuleTypeSetValue().</span></span><br><span class="line"><span class="comment"> * If the key is NULL, is not associated with a module type, or is empty,</span></span><br><span class="line"><span class="comment"> * then NULL is returned instead. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">RedisModule_ModuleTypeGetValue</span><span class="params">(RedisModuleKey *key)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="rdb-loading-and-saving-functions">RDB loading and saving functions</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Returns true if any previous IO API failed.</span></span><br><span class="line"><span class="comment"> * for Load* APIs the REDISMODULE_OPTIONS_HANDLE_IO_ERRORS flag must be set with</span></span><br><span class="line"><span class="comment"> * RediModule_SetModuleOptions first. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_IsIOError</span><span class="params">(RedisModuleIO *io)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Save an unsigned 64 bit value into the RDB file. This function should only</span></span><br><span class="line"><span class="comment"> * be called in the context of the rdb_save method of modules implementing new</span></span><br><span class="line"><span class="comment"> * data types. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_SaveUnsigned</span><span class="params">(RedisModuleIO *io, <span class="keyword">uint64_t</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Load an unsigned 64 bit value from the RDB file. This function should only</span></span><br><span class="line"><span class="comment"> * be called in the context of the rdb_load method of modules implementing</span></span><br><span class="line"><span class="comment"> * new data types. */</span></span><br><span class="line"><span class="keyword">uint64_t</span> RedisModule_LoadUnsigned(RedisModuleIO *io);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like RedisModule_SaveUnsigned() but for signed 64 bit values. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_SaveSigned</span><span class="params">(RedisModuleIO *io, <span class="keyword">int64_t</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like RedisModule_LoadUnsigned() but for signed 64 bit values. */</span></span><br><span class="line"><span class="keyword">int64_t</span> RedisModule_LoadSigned(RedisModuleIO *io);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* In the context of the rdb_save method of a module type, saves a</span></span><br><span class="line"><span class="comment"> * string into the RDB file taking as input a RedisModuleString.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The string can be later loaded with RedisModule_LoadString() or</span></span><br><span class="line"><span class="comment"> * other Load family functions expecting a serialized string inside</span></span><br><span class="line"><span class="comment"> * the RDB file. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_SaveString</span><span class="params">(RedisModuleIO *io, RedisModuleString *s)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* In the context of the rdb_load method of a module data type, loads a string</span></span><br><span class="line"><span class="comment"> * from the RDB file, that was previously saved with RedisModule_SaveString()</span></span><br><span class="line"><span class="comment"> * functions family.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The returned string is a newly allocated RedisModuleString object, and</span></span><br><span class="line"><span class="comment"> * the user should at some point free it with a call to RedisModule_FreeString().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the data structure does not store strings as RedisModuleString objects,</span></span><br><span class="line"><span class="comment"> * the similar function RedisModule_LoadStringBuffer() could be used instead. */</span></span><br><span class="line"><span class="function">RedisModuleString *<span class="title">RedisModule_LoadString</span><span class="params">(RedisModuleIO *io)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like RedisModule_SaveString() but takes a raw C pointer and length as input. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_SaveStringBuffer</span><span class="params">(RedisModuleIO *io, <span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like RedisModule_LoadString() but returns an heap allocated string that</span></span><br><span class="line"><span class="comment"> * was allocated with RedisModule_Alloc(), and can be resized or freed with</span></span><br><span class="line"><span class="comment"> * RedisModule_Realloc() or RedisModule_Free().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The size of the string is stored at '*lenptr' if not NULL.</span></span><br><span class="line"><span class="comment"> * The returned string is not automatically NULL terminated, it is loaded</span></span><br><span class="line"><span class="comment"> * exactly as it was stored inisde the RDB file. */</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">RedisModule_LoadStringBuffer</span><span class="params">(RedisModuleIO *io, <span class="keyword">size_t</span> *lenptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* In the context of the rdb_save method of a module data type, saves a double</span></span><br><span class="line"><span class="comment"> * value to the RDB file. The double can be a valid number, a NaN or infinity.</span></span><br><span class="line"><span class="comment"> * It is possible to load back the value with RedisModule_LoadDouble(). */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_SaveDouble</span><span class="params">(RedisModuleIO *io, <span class="keyword">double</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* In the context of the rdb_save method of a module data type, loads back the</span></span><br><span class="line"><span class="comment"> * double value saved by RedisModule_SaveDouble(). */</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">RedisModule_LoadDouble</span><span class="params">(RedisModuleIO *io)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* In the context of the rdb_save method of a module data type, saves a float</span></span><br><span class="line"><span class="comment"> * value to the RDB file. The float can be a valid number, a NaN or infinity.</span></span><br><span class="line"><span class="comment"> * It is possible to load back the value with RedisModule_LoadFloat(). */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_SaveFloat</span><span class="params">(RedisModuleIO *io, <span class="keyword">float</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* In the context of the rdb_save method of a module data type, loads back the</span></span><br><span class="line"><span class="comment"> * float value saved by RedisModule_SaveFloat(). */</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">RedisModule_LoadFloat</span><span class="params">(RedisModuleIO *io)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* In the context of the rdb_save method of a module data type, saves a long double</span></span><br><span class="line"><span class="comment"> * value to the RDB file. The double can be a valid number, a NaN or infinity.</span></span><br><span class="line"><span class="comment"> * It is possible to load back the value with RedisModule_LoadLongDouble(). */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_SaveLongDouble</span><span class="params">(RedisModuleIO *io, <span class="keyword">long</span> <span class="keyword">double</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* In the context of the rdb_save method of a module data type, loads back the</span></span><br><span class="line"><span class="comment"> * long double value saved by RedisModule_SaveLongDouble(). */</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">double</span> <span class="title">RedisModule_LoadLongDouble</span><span class="params">(RedisModuleIO *io)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="aof-api-for-modules-data-types">AOF API for modules data types</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Emits a command into the AOF during the AOF rewriting process. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_EmitAOF</span><span class="params">(RedisModuleIO *io, <span class="keyword">const</span> <span class="keyword">char</span> *cmdname, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>该函数只在 <code>aof_rewrite</code> 函数中调用</li>
<li>执行模式和 <code>RedisModule_Call()</code> 相同，但是无返回值，异常情况由 Redis 自身处理</li>
</ul>
<h3 id="io-context-handling">IO context handling</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">RedisModuleCtx *<span class="title">RedisModule_GetContextFromIO</span><span class="params">(RedisModuleIO *io)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns a RedisModuleString with the name of the key currently saving or</span></span><br><span class="line"><span class="comment"> * loading, when an IO data type callback is called.  There is no guarantee</span></span><br><span class="line"><span class="comment"> * that the key name is always available, so this may return NULL. */</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> RedisModuleString *<span class="title">RedisModule_GetKeyNameFromIO</span><span class="params">(RedisModuleIO *io)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns a RedisModuleString with the name of the key from RedisModuleKey */</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> RedisModuleString *<span class="title">RedisModule_GetKeyNameFromModuleKey</span><span class="params">(RedisModuleKey *key)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="key-digest-api">Key digest API</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Add a new element to the digest. This function can be called multiple times</span></span><br><span class="line"><span class="comment"> * one element after the other, for all the elements that constitute a given</span></span><br><span class="line"><span class="comment"> * data structure. The function call must be followed by the call to</span></span><br><span class="line"><span class="comment"> * `RedisModule_DigestEndSequence` eventually, when all the elements that are</span></span><br><span class="line"><span class="comment"> * always in a given order are added. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_DigestAddStringBuffer</span><span class="params">(RedisModuleDigest *md,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *ele, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like `RedisModule_DigestAddStringBuffer()` but takes a long long as input</span></span><br><span class="line"><span class="comment"> * that gets converted into a string before adding it to the digest. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_DigestAddLongLong</span><span class="params">(RedisModuleDigest *md, <span class="keyword">long</span> <span class="keyword">long</span> ll)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_DigestEndSequence</span><span class="params">(RedisModuleDigest *md)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="replicate">Replicate</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_Replicate</span><span class="params">(RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> <span class="keyword">char</span> *cmdname, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br></pre></td></tr></table></figure>
<p>TODO</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_ReplicateVerbatim</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br></pre></td></tr></table></figure>
<p>TODO</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_AvoidReplicaTraffic</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>TODO</p>
<h2 id="其他">其他</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Lookup the requested module API and store the function pointer</span></span><br><span class="line"><span class="comment"> * into the target pointer. The function returns REDISMODULE_ERR</span></span><br><span class="line"><span class="comment"> * if there is no such named API, otherwise REDISMODULE_OK. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_GetApi</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *funcname, <span class="keyword">void</span> **targetPtrPtr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return non-zero if a module command, that was declared with the</span></span><br><span class="line"><span class="comment"> * flag "getkeys-api", is called in a special way to get the keys</span></span><br><span class="line"><span class="comment"> * position and not to get executed. Otherwise zero is returned. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_IsKeysPositionRequest</span><span class="params">(RedisModuleCtx *ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The command impl checks for this special call using the</span></span><br><span class="line"><span class="comment"> * RedisModule_IsKeysPositionRequest() and uses this function to report keys.*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_KeyAtPos</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">int</span> pos)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Called by RM_Init() to setup the ctx-&gt;module structure */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_SetModuleAttribs</span><span class="params">(RedisModuleCtx *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> ver, <span class="keyword">int</span> apiver)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return non-zero if the module name is busy. Otherwise zero is returned. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_IsModuleNameBusy</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return the current UNIX time in milliseconds. */</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">RedisModule_Milliseconds</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set flags defining capabilities or behavior bit flags.</span></span><br><span class="line"><span class="comment"> * i.e. REDISMODULE_OPTIONS_HANDLE_IO_ERRORS */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModule_SetModuleOptions</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">int</span> options)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Signals that the key is modified from user's perspective</span></span><br><span class="line"><span class="comment"> * i.e. invalidate WATCH and client side caching. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_SignalModifiedKey</span><span class="params">(RedisModuleCtx *ctx, RedisModuleString *key)</span></span>;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Redis/" rel="tag"># Redis</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/posts/3ac765ba/" rel="next" title="NVM-notes">
                  <i class="fa fa-chevron-left"></i> NVM-notes
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#内存分配与释放"><span class="nav-number">1.</span> <span class="nav-text">内存分配与释放</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redismodulestring"><span class="nav-number">2.</span> <span class="nav-text">RedisModuleString</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#create"><span class="nav-number">2.1.</span> <span class="nav-text">Create</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#free"><span class="nav-number">2.2.</span> <span class="nav-text">Free</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#retain"><span class="nav-number">2.3.</span> <span class="nav-text">Retain</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#convert"><span class="nav-number">2.4.</span> <span class="nav-text">Convert</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#operators"><span class="nav-number">2.5.</span> <span class="nav-text">Operators</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reply"><span class="nav-number">3.</span> <span class="nav-text">Reply</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#other"><span class="nav-number">3.1.</span> <span class="nav-text">Other</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#number"><span class="nav-number">3.2.</span> <span class="nav-text">Number</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#string"><span class="nav-number">3.3.</span> <span class="nav-text">String</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#array"><span class="nav-number">3.4.</span> <span class="nav-text">Array</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#control-command"><span class="nav-number">4.</span> <span class="nav-text">Control command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#low-level-key-apis"><span class="nav-number">5.</span> <span class="nav-text">Low level Key APIs</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#base"><span class="nav-number">5.1.</span> <span class="nav-text">Base</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#string-1"><span class="nav-number">5.2.</span> <span class="nav-text">String</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#list"><span class="nav-number">5.3.</span> <span class="nav-text">List</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zset"><span class="nav-number">5.4.</span> <span class="nav-text">ZSET</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hash"><span class="nav-number">5.5.</span> <span class="nav-text">Hash</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#high-level-key-apis"><span class="nav-number">6.</span> <span class="nav-text">High level Key APIs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#register-a-new-command-in-the-redis-server"><span class="nav-number">7.</span> <span class="nav-text">Register a new command in the Redis server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义数据类型"><span class="nav-number">8.</span> <span class="nav-text">自定义数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#register-a-new-data-type-exported-by-the-module"><span class="nav-number">8.1.</span> <span class="nav-text">Register a new data type exported by the module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#access-to-moduletype"><span class="nav-number">8.2.</span> <span class="nav-text">Access to moduleType</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rdb-loading-and-saving-functions"><span class="nav-number">8.3.</span> <span class="nav-text">RDB loading and saving functions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#aof-api-for-modules-data-types"><span class="nav-number">8.4.</span> <span class="nav-text">AOF API for modules data types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#io-context-handling"><span class="nav-number">8.5.</span> <span class="nav-text">IO context handling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#key-digest-api"><span class="nav-number">8.6.</span> <span class="nav-text">Key digest API</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#replicate"><span class="nav-number">9.</span> <span class="nav-text">Replicate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他"><span class="nav-number">10.</span> <span class="nav-text">其他</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="KyoAni"
    src="/images/k-on.jpg">
  <p class="site-author-name" itemprop="name">KyoAni</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">35</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/yz1509" title="GitHub &rarr; https://github.com/yz1509" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:pro-765@qq.com" title="E-Mail &rarr; mailto:pro-765@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">KyoAni</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  
















  

  
      
<script type="text/x-mathjax-config">
    MathJax.Ajax.config.path['mhchem'] = '//cdn.jsdelivr.net/npm/mathjax-mhchem@3';

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        extensions: ['[mhchem]/mhchem.js'],
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    

  

</body>
</html>
