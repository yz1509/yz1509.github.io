<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">

<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>





  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch.jpg?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/32x32.ico?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/16x16.ico?v=6.3.0">


  <link rel="mask-icon" href="/images/mylogo.jpg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="内存消耗内存消耗可以分为进程自身消耗和子进程消耗。 内存使用统计可通过执行 info memory 命令获取内存相关指标，各项指标详细解释如下：  used_memory：Redis 分配器分配的内存总量，也就是内部存储的所有数据内存占有量 used_memory_human：以可读的格式返回 used_memory used_memory_rss：从操作系统的角度显式 Redis 进程占用的物理">
<meta name="keywords" content="Redis">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis-08-理解内存">
<meta property="og:url" content="https://yz1509.github.io/posts/bb9ea4f2/index.html">
<meta property="og:site_name" content="兔子和阿铁">
<meta property="og:description" content="内存消耗内存消耗可以分为进程自身消耗和子进程消耗。 内存使用统计可通过执行 info memory 命令获取内存相关指标，各项指标详细解释如下：  used_memory：Redis 分配器分配的内存总量，也就是内部存储的所有数据内存占有量 used_memory_human：以可读的格式返回 used_memory used_memory_rss：从操作系统的角度显式 Redis 进程占用的物理">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-07-25T17:00:32.370Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis-08-理解内存">
<meta name="twitter:description" content="内存消耗内存消耗可以分为进程自身消耗和子进程消耗。 内存使用统计可通过执行 info memory 命令获取内存相关指标，各项指标详细解释如下：  used_memory：Redis 分配器分配的内存总量，也就是内部存储的所有数据内存占有量 used_memory_human：以可读的格式返回 used_memory used_memory_rss：从操作系统的角度显式 Redis 进程占用的物理">



  <link rel="alternate" href="/atom.xml" title="兔子和阿铁" type="application/atom+xml" />




  <link rel="canonical" href="https://yz1509.github.io/posts/bb9ea4f2/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Redis-08-理解内存 | 兔子和阿铁</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">兔子和阿铁</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">旅の途中</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yz1509.github.io/posts/bb9ea4f2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yz1509">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mylogo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子和阿铁">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Redis-08-理解内存
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-26 00:36:51 / 修改时间：01:00:32" itemprop="dateCreated datePublished" datetime="2019-07-26T00:36:51+08:00">2019-07-26</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/后端技术栈/" itemprop="url" rel="index"><span itemprop="name">后端技术栈</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="内存消耗"><a href="#内存消耗" class="headerlink" title="内存消耗"></a>内存消耗</h1><p>内存消耗可以分为进程自身消耗和子进程消耗。</p>
<h2 id="内存使用统计"><a href="#内存使用统计" class="headerlink" title="内存使用统计"></a>内存使用统计</h2><p>可通过执行 <code>info memory</code> 命令获取内存相关指标，各项指标详细解释如下：</p>
<ul>
<li><em>used_memory</em>：Redis 分配器分配的内存总量，也就是内部存储的所有数据内存占有量</li>
<li>used_memory_human：以可读的格式返回 used_memory</li>
<li><em>used_memory_rss</em>：从操作系统的角度显式 Redis 进程占用的物理内存总量</li>
<li>used_memory_peak：内存使用的最大值，表示 used_memory 的峰值</li>
<li>used_memory_peak_human：以可读的格式返回 used_memory_peak</li>
<li>used_memory_lua：Lua 引擎所消耗的内存大小</li>
<li><em>mem_gragmentation_ratio</em>：used_memory_rss / used_memory 比值，表示内存碎片率<ul>
<li>当 mem_fragmentation_ratio &gt; 1 时，说明 used_memory_rss - used_memory 多出的部分内存并没有用于数据存储，而是被内存碎片所消耗，如果两者相差很大，说明碎片率严重。</li>
<li>当 mem_fragmentation_ratio &lt; 1 时，这种情况一般出现在操作系统把 Redis 内存交换（Swap）到硬盘导致，出现这种情况时要格外关注，由于硬盘速度远远慢于内存，Redis 性能会变得很差，甚至僵死。</li>
</ul>
</li>
<li>mem_allocator：Redis 所使用的内存分配器，默认为 jemalloc</li>
</ul>
<h2 id="内存消耗划分"><a href="#内存消耗划分" class="headerlink" title="内存消耗划分"></a>内存消耗划分</h2><ol>
<li>自身内存：一个空的Redis进程消耗内存可以忽略不计。</li>
<li>对象内存：Redis 内存占用最大的一块，存储着用户所有的数据。</li>
<li>缓冲内存：主要包括客户端缓冲、复制积压缓冲区和AOF缓冲区。<ul>
<li>客户端缓冲指的是所有接入到 Redis 服务器 TCP 连接的输入输出缓冲。输入缓冲无法控制，最大空间为 1G，如果超过将断开连接。输出缓冲通过参数<code>client-output-buffer-limit</code>控制：<ul>
<li>普通客户端：默认配置 <code>client-output-buffer-limit normal 1000</code></li>
<li>从客户端：主节点会为每个从节点单独建立一条连接用于命令复制，默认配置是：<code>client-output-buffer-limit slave 256mb 64mb 60</code></li>
<li>订阅客户端：当使用发布订阅功能时，连接客户端使用单独的输出缓冲区，默认配置为：<code>client-output-buffer-limit pubsub 32mb 8mb 60</code></li>
</ul>
</li>
<li>复制积压缓冲区：提供了一个可重用的固定大小缓冲区用于实现部分复制功能，根据 <code>repl-backlog-size</code> 参数控制，默认 1MB。对于复制积压缓冲区整个主节点只有一个，所有的从节点共享此缓冲区，因此可以设置较大的缓冲区空间</li>
<li>AOF 缓冲区：用于在 Redis 重写期间保存最近的写入命令，AOF 缓冲区空间消耗用户无法控制，消耗的内存取决于 AOF 重写时间和写入命令量，占用通常很小</li>
</ul>
</li>
<li>内存碎片<ul>
<li>Redis 默认的内存分配器采用 jemalloc，可选的分配器还有：glibc、tcmalloc</li>
<li>内存分配器为了更好地管理和重复利用内存，分配内存策略一般采用固定范围的内存块进行分配</li>
<li>以下场景容易出现高内存碎片问题：<ul>
<li>频繁做更新操作</li>
<li>大量过期键删除，释放的空间无法得到充分利用</li>
</ul>
</li>
<li>常见的解决方式：<ul>
<li>数据对齐</li>
<li>安全重启：重启节点可以做到内存碎片重新整理，因此可以利用高可用架构，如Sentinel 或 Cluster，将碎片率过高的主节点转换为从节点，进行安全重启</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="子进程内存消耗"><a href="#子进程内存消耗" class="headerlink" title="子进程内存消耗"></a>子进程内存消耗</h2><ol>
<li>Redis 产生的子进程并不需要消耗 1 倍的父进程内存，实际消耗根据期间写入命令量决定，但是依然要预留出一些内存防止溢出</li>
<li>需要设置 <code>sysctl vm.overcommit_memory = 1</code> 允许内核可以分配所有的物理内存，防止Redis 进程执行 fork 时因系统剩余内存不足而失败</li>
<li>排查当前系统是否支持并开启 THP，如果开启建议关闭，防止 copy-on-write 期间内存过度消耗</li>
</ol>
<h1 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h1><h2 id="设置内存上限"><a href="#设置内存上限" class="headerlink" title="设置内存上限"></a>设置内存上限</h2><p>Redis 默认无限使用服务器内存，为防止极端情况下导致系统内存耗尽，建议所有的 Redis 进程都要配置 maxmemory。</p>
<p>限制内存的主要目的有：</p>
<ul>
<li>用于缓存场景，当超出内存上限 maxmemory 时使用 LRU 等删除策略释放空间</li>
<li>防止所用内存超过服务器物理内存。但需注意，maxmemory 限制的是 Redis 实际使用的内存量，也就是 used_memory 统计项对应的内存。由于内存碎片率的存在，实际消耗的内存可能会比 maxmemory 设置的更大，实际使用时要小心这部分内存溢出。</li>
</ul>
<h2 id="动态调整内存上限"><a href="#动态调整内存上限" class="headerlink" title="动态调整内存上限"></a>动态调整内存上限</h2><p>Redis 的内存上限可以通过 <code>config set mammemory</code> 进行动态修改，即修改最大可用内存。</p>
<p>在保证物理内存可用的情况下，系统中所有 Redis 实例可以调整 maxmemory 参数来达到自由伸缩内存的目的。</p>
<h2 id="内存回收策略"><a href="#内存回收策略" class="headerlink" title="内存回收策略"></a>内存回收策略</h2><ol>
<li><p>删除过期键对象</p>
<p>Redis 所有的键都可以设置过期属性，内部保存在过期字典中。</p>
<ul>
<li>惰性删除：惰性删除用于当客户端读取带有超时属性的键时，如果已经超过键设置的过期时间，会执行删除操作并返回空<ul>
<li>节省 CPU 成本，不需要单独维护 TTL 链表来处理过期键的删除</li>
<li>当过期键一直没有访问将无法及时得到删除，从而导致内存不能及时释放，存在内存泄露的问题</li>
</ul>
</li>
<li>定时任务删除：Redis 内部维护一个定时任务，默认每秒运行 10 次（通过配置 hz 控制），定时任务中删除过期键逻辑采用了自适应算法，根据键的过期比例、使用快慢两种速率模式回收键</li>
</ul>
</li>
<li><p>内存溢出控制策略</p>
<p>当 Redis 所用内存达到 maxmemory 上限时会触发相应的溢出控制策略。具体策略受<code>maxmemory-policy</code> 参数控制，Redis 支持 6 种策略，如下所示：<br>1) noevicition：默认策略，不会删除任何数据，拒绝所有写入操作并返回客户端错误信息 <code>(error) OOM command not allowed when used memory</code>，此时 Redis 只响应读操作<br>2) volatile-ttl：根据键值对象的 ttl 属性，删除最近将要过期数据。如果没有，回退到noeviction 策略<br>3) volatile-lru：根据 LRU 算法删除设置了超时属性（expire）的键，直到腾出足够空间为止。如果没有可删除的键对象，回退到 noeviction 策略<br>4) volatile-random：随机删除过期键，直到腾出足够空间为止<br>5) allkeys-lru：根据 LRU 算法删除键，不管数据有没有设置超时属性，直到腾出足够空间为止<br>6) allkeys-random：随机删除所有键，直到腾出足够空间为止</p>
<p>内存溢出控制策略可以采用 <code>config set maxmemory-policy {policy}</code> 动态配置。当Redis 因为内存溢出删除键时，可以通过执行 <code>info stats</code> 命令查看 evicted_keys 指标找出当前 Redis 服务器已剔除的键数量。</p>
</li>
</ol>
<h1 id="内存优化"><a href="#内存优化" class="headerlink" title="内存优化"></a>内存优化</h1><h2 id="redisObeject-对象"><a href="#redisObeject-对象" class="headerlink" title="redisObeject 对象"></a>redisObeject 对象</h2><p>Redis 存储的所有值对象在内部定义为 redisObject 结构体，主要包含五个字段：</p>
<ol>
<li><p>type 字段：表示当前对象使用的数据类型</p>
<ul>
<li>Redis 主要支持 5 种数据类型：string、hash、list、set、zset</li>
<li>可以使用 <code>type {key}</code> 命令查看对象所属类型，type 命令返回的是值对象类型，键都是string 类型</li>
</ul>
</li>
<li><p>encoding 字段：表示 Redis 内部编码类型，encoding 在 Redis 内部使用，代表当前对象内部采用哪种数据结构实现</p>
</li>
<li><p>lru 字段：记录对象最后一次被访问的时间</p>
<ul>
<li>当配置了 maxmemory 和 <code>maxmemory-policy = volatile-lru</code> 或者 <code>allkeys-lru</code>时，用于辅助 LRU 算法删除键数据</li>
<li>可以使用 <code>object idletime {key}</code> 命令在不更新 lru 字段情况下查看当前键的空闲时间</li>
<li>可以使用 <code>scan</code> + <code>object idletime</code> 命令批量查询哪些键长时间未被访问，找出长时间不访问的键进行清理，可降低内存占用</li>
</ul>
</li>
<li><p>refcount 字段：记录当前对象被引用的次数</p>
<ul>
<li>当 refcount = 0 时，可以安全回收当前对象空间</li>
<li>使用 <code>object refcount {key}</code>获取当前对象引用次数</li>
<li>当对象为整数且范围在 [0-9999] 时，Redis 可以使用共享对象的方式来节省内存</li>
</ul>
</li>
<li><p>*ptr 字段：与对象的数据内容相关，如果是整数，直接存储数据；否则表示指向数据的指针</p>
<ul>
<li>值对象是字符串且长度 &lt;= 39字节的数据，内部编码为 embstr 类型，字符串 sds 和redisObject 一起分配，从而只要一次内存操作即可</li>
</ul>
</li>
</ol>
<h2 id="缩减键值对象"><a href="#缩减键值对象" class="headerlink" title="缩减键值对象"></a>缩减键值对象</h2><p>降低 Redis 内存使用最直接的方式就是缩减键和值的长度。</p>
<ul>
<li>key 长度：在设计键时，在完整描述业务情况下，键值越短越好</li>
<li>value 长度<ul>
<li>在业务上精简业务对象，去掉不必要的属性避免存储无效数据</li>
<li>将业务对象序列化城二进制数组放入 Redis，且应该选择高效的序列化工具</li>
<li>值对象除了存储二进制数据之外，通常还会使用通用格式（如 json 和 XML 等）作为字符串存储在 Redis 中，可使用通用压缩算法（如 Snappy）进行存储从而降低内存占用</li>
</ul>
</li>
</ul>
<h2 id="共享对象池"><a href="#共享对象池" class="headerlink" title="共享对象池"></a>共享对象池</h2><p>共享对象池是指 Redis 内部维护 [0-9999] 的整数对象池。</p>
<ul>
<li>除了整数值对象，其他类型如 list、hash、set、zset 内部元素也可以使用整数对象池。但对于 ziplist 编码的值对象，即使内部数据为整数也无法使用共享对象池，因为 ziplist 是用压缩且内存连续的结构</li>
<li>整数对象池在 Redis 中通过变量 <code>REDIS_SHARED_INTEGERS</code> 定义，不能通过配置修改</li>
<li>可以通过 <code>object refcount</code> 命令查看对象引用数验证是否启用整数对象池技术</li>
<li>当设置 maxmemory 并启用 LRU 相关淘汰策略如：volatile-lru，allkeys-lru 时，Redis 禁止使用共享对象池</li>
</ul>
<h2 id="字符串优化"><a href="#字符串优化" class="headerlink" title="字符串优化"></a>字符串优化</h2><ol>
<li><p>字符串结构：简单动态字符串 (simple dynamic string, SDS)</p>
<ul>
<li>结构<ul>
<li>int len：已用字节长度</li>
<li>int free：未用字节长度</li>
<li>char buf[]：字节数组</li>
</ul>
</li>
<li>特点<ul>
<li>获取字符串长度、已用长度和未用长度为 O(1) 时间复杂度</li>
<li>可用于保存字节数组，支持安全的二进制数据存储</li>
<li>内部实现空间预分配机制，降低内存再分配次数</li>
<li>惰性删除机制，字符串缩减后的空间不释放，作为预分配空间保留</li>
</ul>
</li>
</ul>
</li>
<li><p>预分配机制</p>
<ul>
<li>空间预分配机制：<ul>
<li>第一次创建时，len 属性等于数据实际大小，free = 0，不做预分配</li>
<li>修改后如果已有 free 空间不够且数据小于 1MB，每次预分配数据实际大小一倍容量</li>
<li>修改后如果已有 free 空间不够且数据大于 1MB，每次预分配 1MB 数据</li>
</ul>
</li>
<li>尽量减少字符串频繁修改操作如 append、setrange，改为直接使用 set 修改字符串，降低预分配带来的内存浪费和内存碎片化</li>
</ul>
</li>
<li><p>字符串重构：指不一定把每份数据作为字符串整体存储，像 json 这样的数据可以使用 hash 结构，使用二级结构存储也能帮我们节省内存。同时可以使用 <code>hmget</code>、<code>hmset</code> 命令支持字段的部分读取修改，而不用每次整体存取。</p>
</li>
</ol>
<h2 id="编码优化"><a href="#编码优化" class="headerlink" title="编码优化"></a>编码优化</h2><p>Redis 对外提供了 string、list、hash、set、zet 等类型，但是 Redis 内部针对不同类型存在编码的概念，所谓编码就是具体使用哪种底层数据结构来实现。每种数据类型（type）可以采用至少两种编码方式来实现，编码不同将直接影响数据的内存占用和读写效率。使用 <code>object encoding {key}</code> 命令获取编码类型。</p>
<ol>
<li><p>编码类型转换</p>
<ul>
<li>编码类型转换在 Redis 写入数据时自动完成，这个转换过程是不可逆的，转换规则只能从小内存编码向大内存编码转换</li>
<li>可以使用 <code>config set</code> 命令设置编码相关参数来满足使用压缩编码的条件。对于已经采用非压缩编码类型的数据如 hashtable、linkedlist 等，设置参数后即使数据满足压缩编码条件，Redis 也不会做转换，需要重启 Redis 重新加载数据才能完成转换。</li>
</ul>
</li>
<li><p>ziplist 编码</p>
<p>ziplist 编码中所有数据都是采用线性连续的内存结构，主要的目的是为了节省内存。</p>
<p>ziplist 内部结构：<code>&lt;zlbytes&gt;&lt;zltail&gt;&lt;zllen&gt;&lt;entry-1&gt;&lt;entry-2&gt;...&lt;entry-n&gt;&lt;zlend&gt;</code>，每个 entry 保存具体的数据，内部结构为：<code>&lt;prev_entry_bytes_length&gt;&lt;encoding&gt;&lt;contents&gt;</code>。</p>
<p>ziplist 结构字段含义：</p>
<ul>
<li>zlbytes：记录整个压缩列表所占字节长度，方便重新调整 ziplist 空间。类型是 int-32，长度为 4 字节</li>
<li>zltail：记录压缩列表尾节点距离起始位置的偏移量，方便尾节点弹出操作。类型是 int-32，长度为 4 字节</li>
<li>zllen：记录压缩列表节点数量。类型是 int-16，长度为 2 字节</li>
<li>entry：记录具体的节点，长度根据实际存储的数据而定</li>
<li>prev_entry_bytes_length：记录前一个节点所占空间，用于快速定位上一个节点，可实现列表反向迭代</li>
<li>encoding：标示当前节点编码和长度，前两位表示编码类型：字符串/整数，其余位表示数据长度</li>
<li>contents：保存节点的值，针对实际数据长度做内存占用优化</li>
<li>zlend：记录列表结尾，占用一个字节</li>
</ul>
<p>ziplist 数据结构特点：</p>
<ul>
<li>内部表现为数据紧凑排列的一块连续内存数组</li>
<li>可以模拟双向链表结构，以 O(1) 时间复杂度入队和出队</li>
<li>新增删除操作涉及内存重新分配或释放，加大了操作的复杂性</li>
<li>读写操作涉及复杂的指针移动，最坏时间复杂度为 $O(n^2)$</li>
<li>适合存储小对象和长度有限的数据</li>
</ul>
</li>
<li><p>inset 编码</p>
<p>intset 编码是集合(set)类型编码的一种，内部表现为存储有序、不重复的整数集。当集合只包含整数且长度不超过 <code>set-max-intset-entries</code> 配置时被启用。</p>
<p>intset 字段结构：<code>&lt;encoding&gt;&lt;length&gt;&lt;contents&gt;</code></p>
<ul>
<li>encoding：整数表示类型，根据集合内最长整数值确定类型，整数类型划分为三种：int-16、int-32、int-64</li>
<li>length：表示集合元素个数</li>
<li>contents：整数数组，按从小到大顺序保存</li>
</ul>
<p>intset 保存的整数类型根据长度划分，当保存的整数超出当前类型时，将会触发自动升级操作且升级后不再做回退。升级操作将会导致重新申请内存空间，把原有数据按转换类型后拷贝到新数组。因此，使用 intset 编码的集合时，尽量保持整数范围一致，防止个别大整数触发集合升级操作，产生内存浪费。</p>
</li>
</ol>
<h2 id="控制键的数量"><a href="#控制键的数量" class="headerlink" title="控制键的数量"></a>控制键的数量</h2><p>对于存储相同的数据内容，利用 Redis 的数据结构降低外层键的数量，也可以节省大量内存。</p>
<p>ziplist 编码的 hash 结构降低键数量：</p>
<ul>
<li>通过在客户端预估键规模，把大量键分组映射到多个 hash 结构中降低键的数量</li>
<li>hash 的 field 可用于记录原始 key 字符串，方便哈希查找</li>
<li>hash 的 value 保存原始值对象，确保不要超过 <code>hash-max-ziplist-value</code> 限制</li>
</ul>
<p>这种内存优化技巧的关键点：</p>
<ul>
<li>hash 类型节省内存的原理是使用 ziplist 编码，如果使用 hashtable 编码方式反而会增加内存消耗</li>
<li>ziplist 长度需要控制在 1000 以内，否则由于存取操作时间复杂度在 $O(n)$ 到 $O(n^2)$ 之间，长列表会导致 CPU 消耗严重，得不偿失</li>
<li>ziplist 适合存储小对象，对于大对象不但内存优化效果不明显还会增加命令操作耗时</li>
<li>需要预估键的规模，从而确定每个 hash 结构需要存储的元素数量</li>
<li>根据 hash 长度和元素大小，调整 <code>hash-max-ziplist-entries</code> 和 <code>hash-maxziplist-value</code> 参数，确保 hash 类型使用 ziplist 编码</li>
</ul>
<p>关于 hash 键和 field 键的设计：</p>
<ul>
<li>当键离散度较高时，可以按字符串位截取，如把后三位作为哈希的 field，之前部分作为哈希的键</li>
<li>当键离散度较低时，可以使用哈希算法打散键</li>
<li>尽量减少 hash 键和 field 的长度，如使用部分键内容</li>
</ul>
<p>hash 重构后所有的键无法再使用超时（expire）和 LRU 淘汰机制自动删除，需要手动维护删除。</p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Redis/" rel="tag"><i class="fa fa-tag"></i> Redis</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/45ffe189/" rel="next" title="Redis-07-阻塞">
                <i class="fa fa-chevron-left"></i> Redis-07-阻塞
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/4f9fe246/" rel="prev" title="Redis-09-哨兵">
                Redis-09-哨兵 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/mylogo.jpg"
                alt="yz1509" />
            
              <p class="site-author-name" itemprop="name">yz1509</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">42</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/yz1509" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:gf940312@mail.ustc.edu.cn" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#内存消耗"><span class="nav-number">1.</span> <span class="nav-text">内存消耗</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#内存使用统计"><span class="nav-number">1.1.</span> <span class="nav-text">内存使用统计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内存消耗划分"><span class="nav-number">1.2.</span> <span class="nav-text">内存消耗划分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#子进程内存消耗"><span class="nav-number">1.3.</span> <span class="nav-text">子进程内存消耗</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#内存管理"><span class="nav-number">2.</span> <span class="nav-text">内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#设置内存上限"><span class="nav-number">2.1.</span> <span class="nav-text">设置内存上限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态调整内存上限"><span class="nav-number">2.2.</span> <span class="nav-text">动态调整内存上限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内存回收策略"><span class="nav-number">2.3.</span> <span class="nav-text">内存回收策略</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#内存优化"><span class="nav-number">3.</span> <span class="nav-text">内存优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#redisObeject-对象"><span class="nav-number">3.1.</span> <span class="nav-text">redisObeject 对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缩减键值对象"><span class="nav-number">3.2.</span> <span class="nav-text">缩减键值对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#共享对象池"><span class="nav-number">3.3.</span> <span class="nav-text">共享对象池</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#字符串优化"><span class="nav-number">3.4.</span> <span class="nav-text">字符串优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编码优化"><span class="nav-number">3.5.</span> <span class="nav-text">编码优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制键的数量"><span class="nav-number">3.6.</span> <span class="nav-text">控制键的数量</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yz1509</span>

  

  
</div>











        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                //var articleUrl = decodeURIComponent(data.url);
                var articleUrl = decodeURIComponent(data.url).substring(1);//截取第一位/斜杠
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      TeX: {equationNumbers: { autoNumber: "AMS" }}
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  
  

  

  

  

  

  

</body>
</html>
