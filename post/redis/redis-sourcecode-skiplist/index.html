<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Redis 源码阅读 --- skiplist - HTT - ふわふわ時間</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="765PRO.P" />
  <meta name="description" content="Redis 跳跃表相关源码阅读笔记，源码文件 server.h &amp;amp; t_zset.c。
" />

  <meta name="keywords" content="K-ON, KyoAni" />






<meta name="generator" content="Hugo 0.85.0" />


<link rel="canonical" href="https://k-on.me/post/redis/redis-sourcecode-skiplist/" />







<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">








<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Redis 源码阅读 --- skiplist" />
<meta property="og:description" content="Redis 跳跃表相关源码阅读笔记，源码文件 server.h &amp; t_zset.c。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://k-on.me/post/redis/redis-sourcecode-skiplist/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-10-06T11:10:35+08:00" />
<meta property="article:modified_time" content="2020-10-06T11:10:35+08:00" />

<meta itemprop="name" content="Redis 源码阅读 --- skiplist">
<meta itemprop="description" content="Redis 跳跃表相关源码阅读笔记，源码文件 server.h &amp; t_zset.c。"><meta itemprop="datePublished" content="2020-10-06T11:10:35+08:00" />
<meta itemprop="dateModified" content="2020-10-06T11:10:35+08:00" />
<meta itemprop="wordCount" content="2650">
<meta itemprop="keywords" content="Redis,Skip list," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Redis 源码阅读 --- skiplist"/>
<meta name="twitter:description" content="Redis 跳跃表相关源码阅读笔记，源码文件 server.h &amp; t_zset.c。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">HTT</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/about/">About</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/categories/">Categories</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      HTT
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/about/">About</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/categories/">Categories</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Redis 源码阅读 --- skiplist</h1>
      
      <div class="post-meta">
        <time datetime="2020-10-06" class="post-time">
          2020-10-06
        </time>
        <div class="post-category">
            <a href="https://k-on.me/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"> 数据库 </a>
            
          </div>
        <span class="more-meta"> 2650 words </span>
          <span class="more-meta"> 6 min read </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1-小结">1. 小结</a></li>
    <li><a href="#2-跳跃表相关数据结构">2. 跳跃表相关数据结构</a></li>
    <li><a href="#3-跳跃表-apis">3. 跳跃表 APIs</a>
      <ul>
        <li><a href="#31-构造函数">3.1. 构造函数</a></li>
        <li><a href="#32-析构函数">3.2. 析构函数</a></li>
        <li><a href="#33-插入节点">3.3. 插入节点</a></li>
        <li><a href="#34-score-range-apis">3.4. Score range APIs</a></li>
        <li><a href="#35-lexicographic-range-apis">3.5. Lexicographic range APIs</a></li>
        <li><a href="#36-删除节点">3.6. 删除节点</a></li>
        <li><a href="#37-zslupdatescore">3.7. zslUpdateScore</a></li>
        <li><a href="#38-get-apis">3.8. Get APIs</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>Redis 跳跃表相关源码阅读笔记，源码文件 <code>server.h</code> &amp; <code>t_zset.c</code>。</p>
<hr>
<h2 id="1-小结">1. 小结</h2>
<p>在 Redis 中实现的跳跃表：</p>
<ul>
<li>最大层数为 <a href="https://github.com/redis/redis/blob/6.0.11/src/server.h#L358">ZSKIPLIST_MAXLEVEL</a></li>
<li>跳跃表中不允许相同的 <code>ele</code>，允许相同的 <code>score</code>，按 <code>&lt;score, ele&gt;</code> pair 进行排序</li>
<li>增加 <code>backward</code> 指针，可反向遍历跳跃表</li>
</ul>
<h2 id="2-跳跃表相关数据结构">2. 跳跃表相关数据结构</h2>
<p>跳跃表之于普通链表，如同增加快速通道的地铁线路之于单一地铁线路，从<strong>普通</strong>到<strong>特急</strong>停靠站越来越少，因此到达目的地所需时间也越短。跳跃表也是利用“快速通道”使得查找、插入和删除等操作更高效，可通过阅读<a href="https://en.wikipedia.org/wiki/Skip_list">维基百科</a>了解详情。</p>
<p><img src="https://pic.pimg.tw/kevin760515/1458824287-246944453.png" alt="地铁路线图"></p>
<p>Redis 中跳跃表大致基于论文<a href="https://15721.courses.cs.cmu.edu/spring2018/papers/08-oltpindexes1/pugh-skiplists-cacm1990.pdf">Skip Lists: A Probabilistic Alternative to Balanced Trees</a>实现，但有三处改动：</p>
<ul>
<li>允许相同的 <code>score</code></li>
<li>比较不仅仅是基于 <code>score</code> 的大小</li>
<li>增加 <code>backward</code> 指针，用于反向遍历</li>
</ul>
<p><img src="/redis/skip_lists.png" alt="skip_lists"></p>
<p>跳跃表 <code>zskiplist</code> 的结构如下所示:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">zskiplist</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="nc">zskiplistNode</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
<span class="p">}</span> <span class="n">zskiplist</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>header</code> 和 <code>tail</code> 分别指向跳跃表的头尾节点</li>
<li><code>length</code> 记录该跳跃表中节点个数</li>
<li><code>level</code> 记录该跳跃表中除头节点外其他节点的最大层数，其上限为 <code>ZSKIPLIST_MAXLEVEL</code></li>
</ul>
<p>在跳跃表中，每个节点 <code>zskiplistNode</code> 的结构如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">zskiplistNode</span> <span class="p">{</span>
    <span class="n">sds</span> <span class="n">ele</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">score</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">zskiplistNode</span> <span class="o">*</span><span class="n">backward</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">zskiplistLevel</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="nc">zskiplistNode</span> <span class="o">*</span><span class="n">forward</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">span</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">level</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">zskiplistNode</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>ele</code>: <code>member</code> 的地址，不允许相同的 <code>member</code></li>
<li><code>backward</code>: 指向前一节点</li>
<li><code>level[]</code>: 每个节点含有复数层的遍历通道，每一层包含在该层下一节点的地址 <code>forward</code>，以及此时的步长 <code>span</code>，当 <code>forward</code> 为 <code>NULL</code> 时，<code>span</code> 等于 0</li>
</ul>
<p>此外，还有表示 <code>score</code> 区间的 <code>zrangespec</code> 和 <code>ele</code> 区间的 <code>zlexrangespec</code>，定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Struct to hold a inclusive/exclusive range spec by score comparison. */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">minex</span><span class="p">,</span> <span class="n">maxex</span><span class="p">;</span> <span class="cm">/* are min or max exclusive? */</span>
<span class="p">}</span> <span class="n">zrangespec</span><span class="p">;</span>

<span class="cm">/* Struct to hold an inclusive/exclusive range spec by lexicographic comparison. */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">sds</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>     <span class="cm">/* May be set to shared.(minstring|maxstring) */</span>
    <span class="kt">int</span> <span class="n">minex</span><span class="p">,</span> <span class="n">maxex</span><span class="p">;</span> <span class="cm">/* are min or max exclusive? */</span>
<span class="p">}</span> <span class="n">zlexrangespec</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="3-跳跃表-apis">3. 跳跃表 APIs</h2>
<h3 id="31-构造函数">3.1. 构造函数</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Create a skiplist node with the specified number of levels.
</span><span class="cm"> * The SDS string &#39;ele&#39; is referenced by the node after the call. */</span>
<span class="n">zskiplistNode</span> <span class="o">*</span><span class="nf">zslCreateNode</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">double</span> <span class="n">score</span><span class="p">,</span> <span class="n">sds</span> <span class="n">ele</span><span class="p">);</span>

<span class="cm">/* Create a new skiplist. */</span>
<span class="n">zskiplist</span> <span class="o">*</span><span class="nf">zslCreate</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>初始化时，<code>zsl-&gt;level</code> 等于 1，头节点的 <code>level</code> 数组长度为 <code>ZSKIPLIST_MAXLEVEL</code></p>
<h3 id="32-析构函数">3.2. 析构函数</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Free the specified skiplist node. The referenced SDS string representation
</span><span class="cm"> * of the element is freed too, unless node-&gt;ele is set to NULL before calling
</span><span class="cm"> * this function. */</span>
<span class="kt">void</span> <span class="nf">zslFreeNode</span><span class="p">(</span><span class="n">zskiplistNode</span> <span class="o">*</span><span class="n">node</span><span class="p">);</span>

<span class="cm">/* Free a whole skiplist. */</span>
<span class="kt">void</span> <span class="nf">zslFree</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="33-插入节点">3.3. 插入节点</h3>
<p><strong>zslRandomLevel</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Returns a random level for the new skiplist node we are going to create.
</span><span class="cm"> * The return value of this function is between 1 and ZSKIPLIST_MAXLEVEL
</span><span class="cm"> * (both inclusive), with a powerlaw-alike distribution where higher
</span><span class="cm"> * levels are less likely to be returned. */</span>
<span class="kt">int</span> <span class="nf">zslRandomLevel</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>返回一个随机的 <code>level</code>，设 <code>ZSKIPLIST_P</code> 为 $p$，<code>ZSKIPLIST_MAXLEVEL</code> 为 $ml$ 则 <code>level</code> 值 $i$ 与其对应的概率 $P(i)$ 满足下式：</p>
<p>$$
P(i) =
\begin{cases}
(1-p)p^{i-1},  &amp; i \ne ml \cr
1 - \Sigma_{i=1}^{ml - 1}P(i), &amp; i = ml \cr
\end{cases}
$$</p>
<p><strong>zslInsert</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Insert a new node in the skiplist. Assumes the element does not already
</span><span class="cm"> * exist (up to the caller to enforce that). The skiplist takes ownership
</span><span class="cm"> * of the passed SDS string &#39;ele&#39;. */</span>
<span class="n">zskiplistNode</span> <span class="o">*</span><span class="nf">zslInsert</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="kt">double</span> <span class="n">score</span><span class="p">,</span> <span class="n">sds</span> <span class="n">ele</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>插入一个新节点至跳跃表，调用方应保证 <code>ele</code> 此前不存在于跳跃表 <code>zsl</code> 中。插入操作流程如下：</p>
<ol>
<li>
<p>按照 <code>level</code> 从大到小寻找每一层中最靠近($&lt;$)新节点的目标节点并记录其地址 (该目标节点 score 小于新节点 <code>socre</code> 或 score 相同时 ele 小于新节点 <code>ele</code>)</p>
</li>
<li>
<p>调用 <code>zslRandomLevel</code> 给新节点生成一个随机的 <code>level</code> 值，若该 <code>level</code> 值大于 <code>zsl-&gt;level</code>，则将为 <code>zsl-&gt;level</code> 至 <code>level</code> 每层最靠近新节点的目标节点初始化为头节点，随后更新 <code>zsl-&gt;level</code> 值</p>
</li>
<li>
<p>根据 <code>level</code>、<code>score</code> 和 <code>ele</code> 值调用 <code>zslCreateNode</code> 创建新节点，并将其插入跳跃表中，更新新节点以及每层中最靠近新节点的目标节点的 <code>level</code> 数组的内容:</p>
<ul>
<li>新节点 <code>level</code> 值大于之前 <code>zsl-&gt;level</code> 时，每层目标节点的 <code>forward</code> 和 <code>span</code> 都需更新</li>
<li>新节点 <code>level</code> 值小于之前 <code>zsl-&gt;level</code> 时，0 -&gt; <code>level</code> 层目标节点的 <code>forward</code> 和 <code>span</code> 都需更新，而 <code>level</code> -&gt; <code>zsl-&gt;level</code> 层目标节点只需更新 <code>span</code> 值</li>
</ul>
</li>
<li>
<p>更新新节点和其后一节点(level = 0)的 <code>backward</code> 指针</p>
</li>
<li>
<p>更新 <code>zsl-&gt;length</code></p>
</li>
</ol>
<p>可以看出，在跳跃表中查找操作和在不考虑换乘时间的情况下最快到达目的车站所采取的策略相同，要点有二:</p>
<ul>
<li>尽可能搭乘快速列车，也即要在该层找到新节点的左极限</li>
<li>不要坐过站，也即每次在该层新节点的左极限时跳转至下层，寻找更接近新节点的跳跃表节点，直至最底层</li>
</ul>
<h3 id="34-score-range-apis">3.4. Score range APIs</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Populate the rangespec according to the objects min and max.
</span><span class="cm"> *
</span><span class="cm"> * Parse the min-max interval. If one of the values is prefixed
</span><span class="cm"> * by the &#34;(&#34; character, it&#39;s considered &#34;open&#34;. For instance
</span><span class="cm"> * ZRANGEBYSCORE zset (1.5 (2.5 will match min &lt; x &lt; max
</span><span class="cm"> * ZRANGEBYSCORE zset 1.5 2.5 will instead match min &lt;= x &lt;= max */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">zslParseRange</span><span class="p">(</span><span class="n">robj</span> <span class="o">*</span><span class="n">min</span><span class="p">,</span> <span class="n">robj</span> <span class="o">*</span><span class="n">max</span><span class="p">,</span> <span class="n">zrangespec</span> <span class="o">*</span><span class="n">spec</span><span class="p">);</span>

<span class="cm">/* Returns if there is a part of the zset is in range. */</span>
<span class="kt">int</span> <span class="nf">zslIsInRange</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="n">zrangespec</span> <span class="o">*</span><span class="n">range</span><span class="p">);</span>

<span class="cm">/* Find the first node that is contained in the specified range.
</span><span class="cm"> * Returns NULL when no element is contained in the range. */</span>
<span class="n">zskiplistNode</span> <span class="o">*</span><span class="nf">zslFirstInRange</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="n">zrangespec</span> <span class="o">*</span><span class="n">range</span><span class="p">);</span>

<span class="cm">/* Find the last node that is contained in the specified range.
</span><span class="cm"> * Returns NULL when no element is contained in the range. */</span>
<span class="n">zskiplistNode</span> <span class="o">*</span><span class="nf">zslLastInRange</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="n">zrangespec</span> <span class="o">*</span><span class="n">range</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="35-lexicographic-range-apis">3.5. Lexicographic range APIs</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Parse max or min argument of ZRANGEBYLEX.
</span><span class="cm">  * (foo means foo (open interval)
</span><span class="cm">  * [foo means foo (closed interval)
</span><span class="cm">  * - means the min string possible
</span><span class="cm">  * + means the max string possible
</span><span class="cm">  *
</span><span class="cm">  * If the string is valid the *dest pointer is set to the redis object
</span><span class="cm">  * that will be used for the comparison, and ex will be set to 0 or 1
</span><span class="cm">  * respectively if the item is exclusive or inclusive. C_OK will be
</span><span class="cm">  * returned.
</span><span class="cm">  *
</span><span class="cm">  * If the string is not a valid range C_ERR is returned, and the value
</span><span class="cm">  * of *dest and *ex is undefined. */</span>
<span class="kt">int</span> <span class="nf">zslParseLexRangeItem</span><span class="p">(</span><span class="n">robj</span> <span class="o">*</span><span class="n">item</span><span class="p">,</span> <span class="n">sds</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ex</span><span class="p">);</span>

<span class="cm">/* Free a lex range structure, must be called only after zelParseLexRange()
</span><span class="cm"> * populated the structure with success (C_OK returned). */</span>
<span class="kt">void</span> <span class="nf">zslFreeLexRange</span><span class="p">(</span><span class="n">zlexrangespec</span> <span class="o">*</span><span class="n">spec</span><span class="p">);</span>

<span class="cm">/* Populate the lex rangespec according to the objects min and max.
</span><span class="cm"> *
</span><span class="cm"> * Return C_OK on success. On error C_ERR is returned.
</span><span class="cm"> * When OK is returned the structure must be freed with zslFreeLexRange(),
</span><span class="cm"> * otherwise no release is needed. */</span>
<span class="kt">int</span> <span class="nf">zslParseLexRange</span><span class="p">(</span><span class="n">robj</span> <span class="o">*</span><span class="n">min</span><span class="p">,</span> <span class="n">robj</span> <span class="o">*</span><span class="n">max</span><span class="p">,</span> <span class="n">zlexrangespec</span> <span class="o">*</span><span class="n">spec</span><span class="p">);</span>

<span class="cm">/* Returns if there is a part of the zset is in the lex range. */</span>
<span class="kt">int</span> <span class="nf">zslIsInLexRange</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="n">zlexrangespec</span> <span class="o">*</span><span class="n">range</span><span class="p">);</span>

<span class="cm">/* Find the first node that is contained in the specified lex range.
</span><span class="cm"> * Returns NULL when no element is contained in the range. */</span>
<span class="n">zskiplistNode</span> <span class="o">*</span><span class="nf">zslFirstInLexRange</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="n">zlexrangespec</span> <span class="o">*</span><span class="n">range</span><span class="p">);</span>

<span class="cm">/* Find the last node that is contained in the specified range.
</span><span class="cm"> * Returns NULL when no element is contained in the range. */</span>
<span class="n">zskiplistNode</span> <span class="o">*</span><span class="nf">zslLastInLexRange</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="n">zlexrangespec</span> <span class="o">*</span><span class="n">range</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>由于跳跃表是按照 <code>score</code> 排序的，因此 <code>zslFirstInLexRange</code> 返回的节点可能比 <code>zslLastInLexRange</code> 返回的节点位置靠后。</p>
<h3 id="36-删除节点">3.6. 删除节点</h3>
<p><strong>zslDeleteNode</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Internal function used by zslDelete, zslDeleteRangeByScore and
</span><span class="cm"> * zslDeleteRangeByRank. */</span>
<span class="kt">void</span> <span class="nf">zslDeleteNode</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="n">zskiplistNode</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">zskiplistNode</span> <span class="o">**</span><span class="n">update</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>从跳跃表 <code>zsl</code> 中删除指定的节点 <code>x</code>，传入的 <code>update</code> 数组记录了每层中最靠近(&lt;) <code>x</code> 的节点地址。值得注意的是，在该函数中无释放操作。</p>
<p><strong>zslDelete</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Delete an element with matching score/element from the skiplist.
</span><span class="cm"> * The function returns 1 if the node was found and deleted, otherwise
</span><span class="cm"> * 0 is returned.
</span><span class="cm"> *
</span><span class="cm"> * If &#39;node&#39; is NULL the deleted node is freed by zslFreeNode(), otherwise
</span><span class="cm"> * it is not freed (but just unlinked) and *node is set to the node pointer,
</span><span class="cm"> * so that it is possible for the caller to reuse the node (including the
</span><span class="cm"> * referenced SDS string at node-&gt;ele). */</span>
<span class="kt">int</span> <span class="nf">zslDelete</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="kt">double</span> <span class="n">score</span><span class="p">,</span> <span class="n">sds</span> <span class="n">ele</span><span class="p">,</span> <span class="n">zskiplistNode</span> <span class="o">**</span><span class="n">node</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>从跳跃表 <code>zsl</code> 中根据 <code>score</code> 和 <code>ele</code> 参数删除特定的节点。</p>
<ul>
<li>该特定节点存在时，删除成功，返回 1，不存在时，删除失败，返回 0</li>
<li>传入的 <code>node</code> 不为 <code>NULL</code> 时，保存被删除节点的地址，<code>node</code> 为空时直接释放被删除节点所占内存</li>
<li>该函数会先寻找距离被删除节点最靠近的目标节点数组，然后调用 <code>zslDeleteNode</code> 执行删除操作</li>
</ul>
<p><strong>zslDeleteRangeBy&hellip;</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Delete all the elements with score between min and max from the skiplist.
</span><span class="cm"> * Min and max are inclusive, so a score &gt;= min || score &lt;= max is deleted.
</span><span class="cm"> * Note that this function takes the reference to the hash table view of the
</span><span class="cm"> * sorted set, in order to remove the elements from the hash table too. */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">zslDeleteRangeByScore</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="n">zrangespec</span> <span class="o">*</span><span class="n">range</span><span class="p">,</span> <span class="n">dict</span> <span class="o">*</span><span class="n">dict</span><span class="p">);</span>

<span class="cm">/* Delete all the elements with ele between min and max from the skiplist. */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">zslDeleteRangeByLex</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="n">zlexrangespec</span> <span class="o">*</span><span class="n">range</span><span class="p">,</span> <span class="n">dict</span> <span class="o">*</span><span class="n">dict</span><span class="p">);</span>

<span class="cm">/* Delete all the elements with rank between start and end from the skiplist.
</span><span class="cm"> * Start and end are inclusive. Note that start and end need to be 1-based */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">zslDeleteRangeByRank</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span>
                                   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end</span><span class="p">,</span> <span class="n">dict</span> <span class="o">*</span><span class="n">dict</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="37-zslupdatescore">3.7. zslUpdateScore</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Update the score of an elmenent inside the sorted set skiplist.
</span><span class="cm"> * Note that the element must exist and must match &#39;score&#39;.
</span><span class="cm"> * This function does not update the score in the hash table side, the
</span><span class="cm"> * caller should take care of it.
</span><span class="cm"> *
</span><span class="cm"> * Note that this function attempts to just update the node, in case after
</span><span class="cm"> * the score update, the node would be exactly at the same position.
</span><span class="cm"> * Otherwise the skiplist is modified by removing and re-adding a new
</span><span class="cm"> * element, which is more costly.
</span><span class="cm"> *
</span><span class="cm"> * The function returns the updated element skiplist node pointer. */</span>
<span class="n">zskiplistNode</span> <span class="o">*</span><span class="nf">zslUpdateScore</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="kt">double</span> <span class="n">curscore</span><span class="p">,</span> <span class="n">sds</span> <span class="n">ele</span><span class="p">,</span> <span class="kt">double</span> <span class="n">newscore</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>调用方需确保根据 <code>cursorce</code> 和 <code>ele</code> 匹配的节点必须存在在跳跃表中</li>
<li>如果 <code>newscore</code> 不改变节点次序，该函数会就地更新指定节点的 <code>score</code> 值，否则会先从跳跃表中删除原节点，再根据 <code>ele</code> 和 <code>newsocre</code> 重新插入新节点</li>
</ul>
<h3 id="38-get-apis">3.8. Get APIs</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Find the rank for an element by both score and key.
</span><span class="cm"> * Returns 0 when the element cannot be found, rank otherwise.
</span><span class="cm"> * Note that the rank is 1-based due to the span of zsl-&gt;header to the
</span><span class="cm"> * first element. */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">zslGetRank</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="kt">double</span> <span class="n">score</span><span class="p">,</span> <span class="n">sds</span> <span class="n">ele</span><span class="p">);</span>

<span class="cm">/* Finds an element by its rank. The rank argument needs to be 1-based. */</span>
<span class="n">zskiplistNode</span><span class="o">*</span> <span class="nf">zslGetElementByRank</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rank</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">765PRO.P</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2020-10-06
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://k-on.me/tags/redis/">Redis</a>
          <a href="https://k-on.me/tags/skip-list/">Skip list</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/redis/redis-sourcecode-object/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Redis 源码阅读 --- Object</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/redis/redis-sourcecode-intset/">
            <span class="next-text nav-default">Redis 源码阅读 --- intset</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="pro-765@qq.com" rel="me noopener" class="iconfont"
      title="email"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/yz1509" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://k-on.me/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        765PRO.P
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>



  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>









  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
