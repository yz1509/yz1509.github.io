<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Introduction to Redis modules - HTT - ふわふわ時間</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="765PRO.P" />
  <meta name="description" content="Redis Modules 入门。
" />

  <meta name="keywords" content="K-ON, KyoAni" />






<meta name="generator" content="Hugo 0.85.0" />


<link rel="canonical" href="https://k-on.me/post/introduction-to-redis-modules/" />







<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">








<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Introduction to Redis modules" />
<meta property="og:description" content="Redis Modules 入门。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://k-on.me/post/introduction-to-redis-modules/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-08-19T16:52:01+00:00" />
<meta property="article:modified_time" content="2020-08-19T16:52:01+00:00" />

<meta itemprop="name" content="Introduction to Redis modules">
<meta itemprop="description" content="Redis Modules 入门。"><meta itemprop="datePublished" content="2020-08-19T16:52:01+00:00" />
<meta itemprop="dateModified" content="2020-08-19T16:52:01+00:00" />
<meta itemprop="wordCount" content="4524">
<meta itemprop="keywords" content="Redis," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Introduction to Redis modules"/>
<meta name="twitter:description" content="Redis Modules 入门。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">HTT</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/about/">About</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/categories/">Categories</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      HTT
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/about/">About</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/categories/">Categories</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Introduction to Redis modules</h1>
      
      <div class="post-meta">
        <time datetime="2020-08-19" class="post-time">
          2020-08-19
        </time>
        <div class="post-category">
            <a href="https://k-on.me/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"> 数据库 </a>
            
          </div>
        <span class="more-meta"> 4524 words </span>
          <span class="more-meta"> 10 min read </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1-introduction-to-redis-modules">1. Introduction to Redis modules</a>
      <ul>
        <li><a href="#11-加载卸载和查看-modules">1.1. 加载、卸载和查看 Modules</a></li>
        <li><a href="#12-模块示例">1.2. 模块示例</a></li>
        <li><a href="#13-redismodulestring">1.3. RedisModuleString</a></li>
        <li><a href="#14-返回响应">1.4. 返回响应</a></li>
        <li><a href="#15-请求有效性检测">1.5. 请求有效性检测</a></li>
        <li><a href="#16-low-level-access-to-keys">1.6. Low level access to keys</a></li>
        <li><a href="#17-high-level-access-to-keys----calling-redis-commands">1.7. High level access to keys &ndash; Calling Redis commands</a></li>
        <li><a href="#18-replicating-commands">1.8. Replicating commands</a></li>
        <li><a href="#19-automatic-memory-management">1.9. Automatic memory management</a></li>
        <li><a href="#110-allocating-memory-into-modules">1.10. Allocating memory into modules</a></li>
      </ul>
    </li>
    <li><a href="#2-implementing-native-data-types">2. Implementing native data types</a>
      <ul>
        <li><a href="#21-registering-a-new-data-types">2.1. Registering a new data types</a></li>
        <li><a href="#22-seting-and-getting-keys">2.2. Seting and getting keys</a></li>
        <li><a href="#23-free-method">2.3. Free method</a></li>
        <li><a href="#24-rdb-load-and-save-methods">2.4. RDB load and save methods</a></li>
        <li><a href="#25-aof-rewriting">2.5. AOF rewriting</a></li>
        <li><a href="#26-handling-multiple-encodings">2.6. Handling multiple encodings</a></li>
        <li><a href="#27-allocating-memory">2.7. Allocating memory</a></li>
      </ul>
    </li>
    <li><a href="#3-blocking-operations-with-modules">3. Blocking operations with modules</a>
      <ul>
        <li><a href="#31-how-blocking-and-resuming-works">3.1. How blocking and resuming works</a></li>
        <li><a href="#32-passing-reply-data-when-unblocking">3.2. Passing reply data when unblocking</a></li>
        <li><a href="#33-aborting-the-blocking-of-a-client">3.3. Aborting the blocking of a client</a></li>
        <li><a href="#34-implementing-the-command-reply-and-timeout-callback-using-a-single-function">3.4. Implementing the command, reply and timeout callback using a single function</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>Redis Modules 入门。</p>
<hr>
<h2 id="1-introduction-to-redis-modules">1. Introduction to Redis modules</h2>
<p><a href="https://redis.io/topics/modules-intro">原文地址</a></p>
<h3 id="11-加载卸载和查看-modules">1.1. 加载、卸载和查看 Modules</h3>
<p><strong>加载</strong></p>
<p>Modules 有两种加载方式：</p>
<ul>
<li>在 <code>redis.conf</code> 中设置：<code>loadmodule /path/to/mymodule.so</code></li>
<li>通过 redis command 实时加载：<code>MODULE LOAD /path/to/mymodule.so</code></li>
</ul>
<p>也可在加载模块时传递参数，如: <code>loadmodule(MODULE LOAD) /path/to/mymodule.so 765 PRO FIGHT</code></p>
<p><strong>卸载</strong></p>
<p>卸载 Modules：<code>MODULE UNLOAD mymodule</code>，如果需要在卸载模块之前进行内存清理之类的操作，可以通过实现 <code>RedisModule_OnUnload</code> 函数来完成，此函数接口为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">RedisModule_OnUnload</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>也可以通过在 <code>RedisModule_OnUnload</code> 中直接返回 <code>REDISMODULE_ERR</code> 禁止模块被卸载。</p>
<p><strong>查看</strong></p>
<p>列出已加载的 Modules: <code>MODULE LIST</code></p>
<h3 id="12-模块示例">1.2. 模块示例</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#include</span> <span class="cpf">&#34;redismodule.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cm">/* The function that implements the command must have the following prototype:
</span><span class="cm"> * int mycommand(RedisModuleCtx *ctx, RedisModuleString **argv, int argc) */</span>
<span class="kt">int</span> <span class="nf">HelloworldRand_RedisCommand</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RedisModule_ReplyWithLongLong</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">rand</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">REDISMODULE_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">RedisModule_OnLoad</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* It should be the first function called by the module OnLoad function.
</span><span class="cm">     * Init function prototype:
</span><span class="cm">     * @return int
</span><span class="cm">     * @param1: RedisModuleCtx *ctx
</span><span class="cm">     * @param2: const char *modeulename
</span><span class="cm">     * @param3: int module_version (reported by MODULE LIST)
</span><span class="cm">     * @param4: int api_version
</span><span class="cm">     * */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">RedisModule_Init</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">&#34;helloworld&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">REDISMODULE_APIVER_1</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDISMODULE_ERR</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">REDISMODULE_ERR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* It used in order to register commands into the Redis core.
</span><span class="cm">     * CreateCommand function prototype:
</span><span class="cm">     * @return int
</span><span class="cm">     * @param1: RedisModuleCtx *ctx
</span><span class="cm">     * @param2: const char *name
</span><span class="cm">     * @param3: RedisModuleCmdFunc cmdfunc
</span><span class="cm">     * @param4: const char *strflags
</span><span class="cm">     * @param5: int firstkey
</span><span class="cm">     * @param6: int lastkey
</span><span class="cm">     * @param7: int keystep
</span><span class="cm">     * */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">RedisModule_CreateCommand</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">&#34;helloworld.rand&#34;</span><span class="p">,</span> <span class="n">HelloworldRand_RedisCommand</span><span class="p">,</span>
                                  <span class="s">&#34;fast random&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDISMODULE_ERR</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">REDISMODULE_ERR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">REDISMODULE_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="13-redismodulestring">1.3. RedisModuleString</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// accesss a string
</span><span class="c1"></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">RedisModule_StringPtrLen</span><span class="p">(</span><span class="n">RedisModuleString</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span> <span class="n">size_t</span> <span class="o">*</span><span class="n">len</span><span class="p">);</span>

<span class="c1">// create new string
</span><span class="c1"></span><span class="n">RedisModuleString</span> <span class="o">*</span><span class="nf">RedisModule_CreateString</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">);</span>

<span class="c1">// create string from number
</span><span class="c1"></span><span class="n">RedisModuleString</span> <span class="o">*</span><span class="n">mystr</span> <span class="o">=</span> <span class="n">RedisModule_CreateStringFromLongLong</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

<span class="c1">// parse string as number
</span><span class="c1"></span><span class="kt">long</span> <span class="kt">long</span> <span class="n">myval</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">RedisModule_StringToLongLong</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">myval</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDISMODULE_OK</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*Do something with myval*/</span>
<span class="p">}</span>

<span class="c1">// free a string which created by RedisModule_CreateString
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">RedisModule_FreeString</span><span class="p">(</span><span class="n">RedisModuleString</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>如果不想手动 free 的话，可以开启自动内存管理</li>
<li>通过 <code>argv</code> 数组传递的参数不要 free</li>
</ul>
<h3 id="14-返回响应">1.4. 返回响应</h3>
<p>在模块中实现的命令可以通过 <code>RedisModule_ReplyWith&lt;something&gt;</code> 接口返回响应至客户端。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Return an error */</span>
<span class="n">RedisModule_ReplyWithError</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">);</span>

<span class="cm">/* Relpy with a long long */</span>
<span class="n">RedisModule_ReplyWithLongLong</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">res</span><span class="p">);</span>

<span class="cm">/* Reply with a simple string, that can&#39;t contain binary values or newlines */</span>
<span class="n">RedisModule_ReplyWithSimpleString</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">res</span><span class="p">);</span>

<span class="cm">/* Reply with bulk strings that are binary safe */</span>
<span class="kt">int</span> <span class="nf">RedisModule_ReplyWithStringBuffer</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">RedisModule_ReplyWithString</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>

<span class="cm">/* Reply with an array, you just need to use a function to
</span><span class="cm"> * emit the array length, followed by as many calls to the
</span><span class="cm"> * above functions as the number of elements of array are. */</span>
<span class="n">RedisModule_ReplyWithArray</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="n">RedisModule_ReplyWithStringBuffer</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">RedisModule_ReplyWithLongLong</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">22</span><span class="p">);</span>

<span class="cm">/* Returning arrays with dynamic length,
</span><span class="cm"> * It is possible to have multiple nested arrays with postponed reply.
</span><span class="cm"> * Each call to ReplySetArrayLength() will set the length of the latest
</span><span class="cm"> * corresponding call to to ReplyWithArray() */</span>
<span class="n">RedisModule_ReplyWithArray</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">REDISMODULE_POSTPONED_ARRAY_LEN</span><span class="p">);</span>
<span class="p">...</span> <span class="n">generate</span> <span class="mi">100</span> <span class="n">elements</span> <span class="p">...</span>
<span class="n">RedisModule_ReplyWithArray</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">REDISMODULE_POSTPONED_ARRAY_LEN</span><span class="p">);</span>
<span class="p">...</span> <span class="n">generate</span> <span class="mi">10</span> <span class="n">elements</span> <span class="p">...</span>
<span class="n">RedisModule_ReplySetArrayLength</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="n">RedisModuel_ReplySetArrayLength</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="15-请求有效性检测">1.5. 请求有效性检测</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Check the number of arguments */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">RedisModule_WrongArity</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Check the type of key */</span>
<span class="n">RedisModuleKey</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">RedisModule_OpenKey</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">REDISMODULE_READ</span><span class="o">|</span><span class="n">REDISMODULE_WRITE</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">key_type</span> <span class="o">=</span> <span class="n">RedisModule_KeyType</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">!=</span> <span class="n">REDISMODULE_KEYTYPE_STRING</span> <span class="o">&amp;&amp;</span> <span class="n">key_type</span> <span class="o">!=</span> <span class="n">REDISMODULE_KEYTYPE_EMPTY</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RedisModule_CloseKey</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">RedisModule_ReplyWithError</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">REDISMODULE_ERRORMSG_WRONGTYPE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="16-low-level-access-to-keys">1.6. Low level access to keys</h3>
<p>访问 Redis 数据库有两种 APIs:</p>
<ul>
<li>low level APIs: 可直接操作 Redis 数据结构，速度快</li>
<li>high level APIs：使用 <code>RedisModule_Call()</code> 函数 call Redis commands</li>
</ul>
<p>在请求有效性检测中，我们已经看过了 low level 操作的简单示例，这些 APIs 为了保证运行速度，并未做很多 run-time checks，因此需要遵守下述规则：</p>
<ul>
<li>同时 Open 相同的 key，并且其中有写操作的话，会产生未定义行为或 crashes</li>
<li>当一个 key 被 Open 时，应该只使用 low level APIs 访问，不可同时和 <code>RedisModule_Call()</code> 混用</li>
</ul>
<p><strong>Open a key for access</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">RedisModuleKey</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
<span class="cm">/* Prototype: void* RedisModule_OpenKey(RedisModuleCtx *ctx,
</span><span class="cm"> *                                      RedisModuleString *keyname, int mode);
</span><span class="cm"> * */</span>
<span class="n">RedisModule_OpenKey</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">REDISMODULE_READ</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>mode</code> 可以是 <code>REDISMODULE_READ</code> 或 <code>REDISMODULE_WRITE</code></li>
<li>打开一个不存在的 key 时
<ul>
<li>
<p><code>REDISMODULE_WRITE</code>：创造新 key，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">RedisModuleKey</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">RedisModule_OpenKey</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">REDISMODULE_WRITE</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">RedisModule_KeyType</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDISMODULE_KEYTYPE_EMPTY</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RedisModule_StringSet</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>REDISMODULE_READ</code>: 返回 <code>NULL</code></p>
</li>
</ul>
</li>
</ul>
<p><strong>Getting the key type</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">key_type</span> <span class="o">=</span> <span class="n">RedisModule_KeyType</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>返回值种类：</p>
<ul>
<li><code>REDISMODULE_KEYTYPE_EMPTY</code></li>
<li><code>REDISMODULE_KEYTYPE_STRING</code></li>
<li><code>REDISMODULE_KEYTYPE_LIST</code></li>
<li><code>REDISMODULE_KEYTYPE_SET</code></li>
<li><code>REDISMODULE_KEYTYPE_ZSET</code></li>
<li><code>REDISMODULE_KEYTYPE_HASH</code></li>
<li><code>REDISMODULE_KEYTYPE_MODULE</code></li>
<li><code>REDISMODULE_KEYTYPE_STREAM</code></li>
</ul>
<p><strong>Managing key expires(TTLs)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Query the current expire of an open key. Return the time to live of the key
</span><span class="cm"> * in milliseconds, or REDISMODULE_NO_EXPIRE as a special value to signal the
</span><span class="cm"> * key has no associated or does not exist at all. */</span>
<span class="n">mstime_t</span> <span class="nf">RedisModule_GetExpire</span><span class="p">(</span><span class="n">RedisModuleKey</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>

<span class="cm">/* Change the expire of a key
</span><span class="cm"> * When called on a non existing key, REDISMODULE_ERR is returned. */</span>
<span class="kt">int</span> <span class="nf">RedisModule_SetExpire</span><span class="p">(</span><span class="n">RedisModuleKey</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">mstime_t</span> <span class="n">expire</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Deleting keys</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* return REDISMODULE_ERR if the key is not open for writing */</span>
<span class="n">RedisModule_DeleteKey</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Close a key</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">RedisModule_CloseKey</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>当自动内存管理功能开启时，也可以不用 close keys。</p>
<p><strong>Obtaining the length of values</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// return the length of values associated to an open key
</span><span class="c1"></span><span class="n">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">RedisModule_ValueLength</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>string</code>: 返回的是字符串长度</li>
<li><code>list</code>, <code>set</code>, <code>zset</code> 和 <code>hash</code>：返回的是元素个数</li>
<li>key 不存在时返回 0</li>
</ul>
<p><strong>String type API</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Setting a new string value, this function works exactly like SET cmd */</span>
<span class="kt">int</span> <span class="nf">RedisModule_StringSet</span><span class="p">(</span><span class="n">RedisModuleKey</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>通过 DMA(direct memory access) 访问字符串类型效率更高，DMA 方位期间该 key 不可有其他操作，否则 DMA 指针非法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">myptr</span> <span class="o">=</span> <span class="n">RedisModule_StringDMA</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">REDISMODULE_WRITE</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">myptr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可通过以下接口改变字符串长度：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">RedisModule_StringTruncate</span><span class="p">(</span><span class="n">mykey</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>如果该 key 操作之前不存在，则会创造新 key</li>
<li>字符串长度扩展时，会填充 zero bytes</li>
</ul>
<p>更多数据类型的 APIs 可见 Modules API reference。</p>
<h3 id="17-high-level-access-to-keys----calling-redis-commands">1.7. High level access to keys &ndash; Calling Redis commands</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">RedisModuleCallReply</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
<span class="cm">/* @return: RedisModuleCallReply on sucess, NUll on error
</span><span class="cm"> * @param1: context
</span><span class="cm"> * @param2: a null terminated C string with the command name
</span><span class="cm"> * @param3: the format specifier where each character corresponds to
</span><span class="cm"> *          the type of the arguments that will follow  */</span>
<span class="n">reply</span> <span class="o">=</span> <span class="n">RedisModule_Call</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">&#34;INCRBY&#34;</span><span class="p">,</span> <span class="s">&#34;sc&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;10&#34;</span><span class="p">);</span>

<span class="cm">/* Accesss a RedisModuleCallReply object */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">RedisModule_CallReplyType</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDISMODULE_REPLY_INTEGER</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">myval</span> <span class="o">=</span> <span class="n">RedisModule_CallReplyInteger</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
    <span class="cm">/* Do something with myval */</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>格式说明符</strong></p>
<ul>
<li><code>c</code> &ndash; Null terminated C string pointer</li>
<li><code>b</code> &ndash; C buffer, two arguments needed: C string pointer and <code>size_t</code> length</li>
<li><code>s</code> &ndash; RedisModuleString as received in <code>argv</code> or by other Redis module APIs returning a RedisModuleString object</li>
<li><code>l</code> &ndash; Long long integer</li>
<li><code>v</code> &ndash; Array of RedisModuleString objects</li>
<li><code>!</code> &ndash; This modifier just tells the function to replicate the command to replicas and AOF. it is ignored from the point of view of arguments parsing</li>
<li><code>A</code> &ndash; This modifier, when <code>!</code> is given, tells to suppress AOF propagation: the command will propagated only to replicas</li>
<li><code>R</code> &ndash; This modifier, when <code>!</code> is given, tells to suppress replicas propagation: the command will be propagated only to the AOF if enabled</li>
</ul>
<p><strong>返回值</strong></p>
<p>函数执行成功时返回 <code>RedisModuleCallReply</code> 对象，失败时返回 <code>NULL</code> 并将 <code>errno</code> 设置为以下值：</p>
<table>
<thead>
<tr>
<th style="text-align:left">errno</th>
<th style="text-align:left">meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">EBADF</td>
<td style="text-align:left">wrong format specifier.</td>
</tr>
<tr>
<td style="text-align:left">EINVAL</td>
<td style="text-align:left">wrong command arity.</td>
</tr>
<tr>
<td style="text-align:left">ENOENT</td>
<td style="text-align:left">command does not exist.</td>
</tr>
<tr>
<td style="text-align:left">EPERM</td>
<td style="text-align:left">operation in Cluster instance with key in non local slot.</td>
</tr>
<tr>
<td style="text-align:left">EROFS</td>
<td style="text-align:left">operation in Cluster instance when a write command is sent in a readonly state. ENETDOWN</td>
</tr>
</tbody>
</table>
<p><strong>RedisModuleCallReply</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">Reply type</th>
<th style="text-align:left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">REDISMODULE_REPLY_STRING</td>
<td style="text-align:left">Bulk string or status replies</td>
</tr>
<tr>
<td style="text-align:left">REDISMODULE_REPLY_ERROR</td>
<td style="text-align:left">Errors</td>
</tr>
<tr>
<td style="text-align:left">REDISMODULE_REPLY_INTEGER</td>
<td style="text-align:left">Signed 64-bit integers</td>
</tr>
<tr>
<td style="text-align:left">REDISMODULE_REPLY_ARRAY</td>
<td style="text-align:left">Array of replies</td>
</tr>
<tr>
<td style="text-align:left">REDISMODULE_REPLY_NULL</td>
<td style="text-align:left">NULL reply</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Strings, errors and arrays hava an associated length.
</span><span class="cm"> * To obtain the reply length: */</span>
<span class="n">size_t</span> <span class="n">reply_len</span> <span class="o">=</span> <span class="n">RedisModule_CallReplyLength</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>

<span class="cm">/* Accesss strings or errors */</span>
<span class="n">size_t</span> <span class="n">len</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">RedisModule_CallReplyStringPtr</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

<span class="cm">/* Accesss sub elements of array */</span>
<span class="n">RedisModuleCallReply</span> <span class="o">*</span><span class="n">sub_reply</span><span class="p">;</span>
<span class="n">sub_reply</span> <span class="o">=</span> <span class="n">RedisModule_CallReplyArrayElement</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

<span class="cm">/* Obtain the value of an integer reply */</span>
<span class="kt">long</span> <span class="kt">long</span> <span class="n">reply_integer_val</span> <span class="o">=</span> <span class="n">RedisModule_CallReplyInteger</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>

<span class="cm">/* RedisModuleCallReply are not the same as RedisModuleString type
</span><span class="cm"> * create a new string object from a call reply of type string, error or integer
</span><span class="cm"> * */</span>
<span class="n">RedisModuleString</span> <span class="o">*</span><span class="n">mystr</span> <span class="o">=</span> <span class="n">RedisModule_CreateStringFromCallReply</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>

<span class="cm">/* Free a reply object
</span><span class="cm"> * For arrays, you need to free only the top level reply, not the nested replies.
</span><span class="cm"> * */</span>
<span class="kt">void</span> <span class="nf">RedisModule_FreeCallReply</span><span class="p">(</span><span class="n">RedisModuleCallReply</span> <span class="o">*</span><span class="n">reply</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="18-replicating-commands">1.8. Replicating commands</h3>
<p>当使用 high level APIs 访问 key，通过加 <code>!</code> 格式说明符，命令自动被复制，如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">reply</span> <span class="o">=</span> <span class="n">RedisModule_Call</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">&#34;INCRBY&#34;</span><span class="p">,</span> <span class="s">&#34;!sc&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;10&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>当使用 low level APIs 时，可通过以下俩个接口复制命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* When you use the follow API, you should not use any other replication
</span><span class="cm"> * function since they are not guaranteed to mix well. */</span>
<span class="n">RedisModule_ReplicateVerbatim</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

<span class="cm">/* Exactly tell Redis what commands to replicate as the effect of the command
</span><span class="cm"> * execution. It&#39;s possible to call RedisModule_Replicate multiple times,
</span><span class="cm"> * and each will emit a command. All the sequence emitted is wrapped between
</span><span class="cm"> * a MULTI/EXEC transaction, so that the AOF and replication effects are
</span><span class="cm"> * the same as executing a single command. */</span>
<span class="n">RedisModule_Replicate</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">&#34;INCRBY&#34;</span><span class="p">,</span> <span class="s">&#34;cl&#34;</span><span class="p">,</span> <span class="s">&#34;foo&#34;</span><span class="p">,</span> <span class="n">my_increment</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="19-automatic-memory-management">1.9. Automatic memory management</h3>
<p>启用自动内存管理，只需在命令实现函数的开头加上 <code>RedisModule_AutoMemory(ctx);</code> 即可，虽然会有些性能损耗，但是你可以不再需要手动 <code>close open keys</code>, <code>free replies</code> 和 <code>free RedisModuleString objects</code>。</p>
<h3 id="110-allocating-memory-into-modules">1.10. Allocating memory into modules</h3>
<p>虽然在模块中可以调用 <code>malloc()</code> 和 <code>free()</code> 函数，但是通过 <code>malloc()</code> 分配的内存并不会被计算到 <code>used_memory</code> 信息中去，也不会受到 <code>maxmemory</code> 限制，所以应首先考虑使用 Redis Modules 提供的 APIs。而且，使用 APIs 分配内存实现的自定义数据结构也可以被 RDB 加载函数正确地反序列化。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="o">*</span><span class="nf">RedisModule_Alloc</span><span class="p">(</span><span class="n">size_t</span> <span class="n">bytes</span><span class="p">);</span>
<span class="kt">void</span><span class="o">*</span> <span class="nf">RedisModule_Realloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">bytes</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">RedisModule_Free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">RedisModule_Calloc</span><span class="p">(</span><span class="n">size_t</span> <span class="n">nmemb</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">RedisModule_Strdup</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>

<span class="cm">/* Pool allocator
</span><span class="cm"> * the memory allocated is automatically released when the command returns. */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">RedisModule_PoolAlloc</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">bytes</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="2-implementing-native-data-types">2. Implementing native data types</h2>
<p><a href="https://redis.io/topics/modules-native-types">原文地址</a></p>
<p>在模块中实现类似 Redis 原生的数据类型需要满足以下几点：</p>
<ul>
<li>The implementation of some kind of new data structure and of commands operating on the new data structure.</li>
<li>A set of callbacks that handle: RDB saving, RDB loading, AOF rewriting, releasing of a value associated with a key, calculation of a value digest (hash) to be used with the DEBUG DIGEST command.</li>
<li>A 9 characters name that is unique to each module native data type.</li>
<li>An encoding version, used to persist into RDB files a module-specific data version, so that a module will be able to load older representations from RDB files.</li>
</ul>
<h3 id="21-registering-a-new-data-types">2.1. Registering a new data types</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Declare a global variable that will hold a reference to the data type */</span>
<span class="k">static</span> <span class="n">RedisModuleType</span> <span class="o">*</span><span class="n">MyType</span><span class="p">;</span>
<span class="cp">#define MYTYPE_ENCODING_VERSION 0
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">RedisModule_OnLoad</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* The follow set of methods must be passed.
</span><span class="cm">     * while .digest and .mem_usage are optinal */</span>
    <span class="n">RedisModuleTypeMethods</span> <span class="n">tm</span> <span class="o">=</span>
    <span class="p">{</span>
        <span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">REDISMODULE_TYPE_METHOD_VERSION</span><span class="p">,</span>
        <span class="p">.</span><span class="n">rdb_load</span> <span class="o">=</span> <span class="n">MyTypeRDBLoad</span><span class="p">,</span>
        <span class="p">.</span><span class="n">rdb_save</span> <span class="o">=</span> <span class="n">MyTypeRDBSave</span><span class="p">,</span>
        <span class="p">.</span><span class="n">aof_rewrite</span> <span class="o">=</span> <span class="n">MyTypeAOFRewrite</span><span class="p">,</span>
        <span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">MyTypeFree</span>
    <span class="p">};</span>

    <span class="cm">/* 9 character name, character set {A-Z, a-z, 0-9, _, -}*/</span>
    <span class="n">MyType</span> <span class="o">=</span> <span class="n">RedisModule_CreateDataType</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">&#34;MyType-AZ&#34;</span><span class="p">,</span>
                                        <span class="n">MYTYPE_ENCODING_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">MyType</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">REDISMODULE_ERR</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Prototypes of type methods</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* mandatory */</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">RedisModuleTypeLoadFunc</span><span class="p">)(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">rdb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">encver</span><span class="p">);</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">RedisModuleTypeSaveFunc</span><span class="p">)(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">rdb</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">RedisModuleTypeRewriteFunc</span><span class="p">)(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">aof</span><span class="p">,</span>
                                           <span class="n">RedisModuleString</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">RedisModuleTypeFreeFunc</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>

<span class="cm">/* optinal */</span>
<span class="k">typedef</span> <span class="n">size_t</span> <span class="p">(</span><span class="o">*</span><span class="n">RedisModuleTypeMemUsageFunc</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">RedisModuleTypeDigestFunc</span><span class="p">)(</span><span class="n">RedisModuleDigest</span> <span class="o">*</span><span class="n">digest</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>rdb_load</code> is called when loading data from the RDB file. It loads data in the same format as rdb_save produces.</li>
<li><code>rdb_save</code> is called when saving data to the RDB file.</li>
<li><code>aof_rewrite</code> is called is called when the AOF is being rewritten, and the module needs to tell Redis what is the sequence of commands to recreate the content of a given key.</li>
<li><code>free</code> is called when a key with the module native type is deleted via DEL or in any other mean, in order to let the module reclaim the memory associated with such a value.</li>
<li><code>digest</code> is called when DEBUG DIGEST is executed and a key holding this module type is found. Currently this is not yet implemented so the function can be left empty.</li>
<li><code>mem_usage</code> is called when the MEMORY command asks for the total memory consumed by a specific key, and is used in order to get the amount of bytes used by the module value.</li>
</ul>
<p><strong>为什么名字要 9 个字符？</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Now RDB files are sequences of key-value pairs like the following: */</span>
<span class="o">---------------------------------------------</span>
<span class="o">|</span> <span class="mi">1</span> <span class="n">byte</span> <span class="n">type</span> <span class="o">|</span> <span class="n">key</span> <span class="o">|</span> <span class="n">a</span> <span class="n">type</span> <span class="n">specific</span> <span class="n">value</span> <span class="o">|</span>
<span class="o">---------------------------------------------</span>

<span class="cm">/* in module data, prefix a type specific value with 64-bit integer
</span><span class="cm"> * 64 = 9 * 6 + 10, 9 characters of 6 bits, 10 bits are used in oreder
</span><span class="cm"> * to store the encoding version of the type */</span>
<span class="o">------------------------------------------</span>
<span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">10</span> <span class="o">|</span>
<span class="o">------------------------------------------</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="22-seting-and-getting-keys">2.2. Seting and getting keys</h3>
<p>使用 low level APIs 去操作自定义的数据结构，例子如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">RedisModuleKey</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">RedisModule_OpenKey</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">REDISMODULE_READ</span><span class="o">|</span><span class="n">REDISMODULE_WRITE</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">RedisModule_KeyType</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="cm">/* Check the key */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">REDISMODULE_KEYTYPE_EMPTY</span> <span class="o">&amp;&amp;</span>
    <span class="n">RedisModule_ModuleTypeGetType</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MyType</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">RedisModule_ReplyWithError</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">REDISMODULE_ERRORMSG_WRONGTYPE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="nc">some_private_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDISMODULE_KEYTYPE_EMPTY</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Create an empty value object if the key is currently empty. */</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">createMyDataStructure</span><span class="p">();</span>
    <span class="n">RedisModule_ModuleTypeSetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">MyType</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="cm">/* Retrieve the private data from a key */</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">RedisModule_ModuleTypeGetValue</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Do something with data */</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="23-free-method">2.3. Free method</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* a simple impl of the free method */</span>
<span class="kt">void</span> <span class="nf">MyTypeFreeCallback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RedisModule_Free</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="24-rdb-load-and-save-methods">2.4. RDB load and save methods</h3>
<p>当调用 RDB saving 或 loading 时，我们需要给出自定义数据类型在磁盘上的排布方式，Redis 提供了在 RDB 文件中存储以下数据类型的 high level APIs：</p>
<ul>
<li>Unsigned 64-bit integers</li>
<li>Signed 64-bit integers</li>
<li>Doubles</li>
<li>Strings</li>
</ul>
<p>APIs 如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="nf">RedisModule_SaveUnsigned</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">uint64_t</span> <span class="nf">RedisModule_LoadUnsigned</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">RedisModule_SaveSigned</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">int64_t</span> <span class="nf">RedisModule_LoadSigned</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">RedisModule_SaveDouble</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span> <span class="kt">double</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">double</span> <span class="nf">RedisModule_LoadDouble</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">RedisModule_SaveString</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="n">RedisModuleString</span> <span class="o">*</span><span class="nf">RedisModule_LoadString</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">RedisModule_SaveStringBuffer</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">RedisModule_LoadStringBuffer</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>一个简单的例子如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="nc">double_array</span>
<span class="p">{</span>
    <span class="n">size_t</span> <span class="n">count</span><span class="p">;</span>
    <span class="kt">double</span> <span class="o">*</span><span class="n">values</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* rdb_save */</span>
<span class="kt">void</span> <span class="nf">DoubleArrayRDBSave</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">double_array</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
    <span class="n">RedisModule_SaveUnsigned</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">RedisModule_SaveDouble</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* rdb_load */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">DoubleArrayRDBLoad</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span> <span class="n">encver</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">encver</span> <span class="o">!=</span> <span class="n">DOUBLE_ARRAY_ENC_VER</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* We should actually log an error here, or try to implement the ability
</span><span class="cm">         * to load older versions of our data structure */</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="nc">double_array</span> <span class="o">*</span><span class="n">da</span><span class="p">;</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">RedisModule_Alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">da</span><span class="p">));</span>
    <span class="n">da</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">RedisModule_LoadUnsigned</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>
    <span class="n">da</span><span class="o">-&gt;</span><span class="n">values</span> <span class="o">=</span> <span class="n">RedisModule_Alloc</span><span class="p">(</span><span class="n">da</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">da</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">da</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">RedisModule_LoadDouble</span><span class="p">(</span><span class="n">io</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">da</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="25-aof-rewriting">2.5. AOF rewriting</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="nf">RedisModule_EmitAOF</span><span class="p">(</span><span class="n">RedisModuleIO</span> <span class="o">*</span><span class="n">io</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmdname</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="26-handling-multiple-encodings">2.6. Handling multiple encodings</h3>
<p>TODO</p>
<h3 id="27-allocating-memory">2.7. Allocating memory</h3>
<p>自定义数据结构的内存管理建议使用 Redis Module 提供的 APIs：</p>
<ul>
<li>自定义数据结构使用的内存会被计算在 <code>used_memory</code> 内，方便 Redis 进行内存管理</li>
<li>Redis 使用的是 <code>jemalloc</code> 分配器，可以降低内存碎片率</li>
<li>与 Redis 内存分配器相同时，从 RDB loading 函数中返回的值无需再次拷贝，可直接访问使用</li>
</ul>
<h2 id="3-blocking-operations-with-modules">3. Blocking operations with modules</h2>
<p><a href="https://redis.io/topics/modules-blocking-ops">原文地址</a></p>
<h3 id="31-how-blocking-and-resuming-works">3.1. How blocking and resuming works</h3>
<p>可使用以下接口让客户端进入 <strong>blocked state</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">RedisModuleBlockedClient</span> <span class="o">*</span><span class="nf">RedisModule_BlockClient</span><span class="p">(</span>
    <span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
    <span class="n">RedisModuleCmdFunc</span> <span class="n">reply_callback</span><span class="p">,</span>
    <span class="n">RedisModuleCmdFunc</span> <span class="n">timeout_callback</span><span class="p">,</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">free_private</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">),</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">timeout_ms</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>该函数返回的 <code>RedisModuleBlockedClient</code> 对象，用于之后 unblock 该客户端</li>
<li><code>ctx</code> is the command execution context as usually in the rest of the API</li>
<li><code>reply_callback</code> is the callback, having the same prototype of a normal command function, that is called when the client is unblokced in order to return a reply to the client</li>
<li><code>timeout_callback</code> is the callback, having the same prototype of a normal command function that is called when the client reached the <code>timeout_ms</code> timeout.</li>
<li><code>free_private</code> is the callback that is called in order to free the private data. Private data is a pointer to some data that is passed between the API used to unblock the client, to the callback that will send the reply to the client.</li>
<li><code>timeout_ms</code> is the timeout in milliseconds. When the timeout is reached, the timeout callback is called and the client is automatically aborted.</li>
</ul>
<p>可使用以下接口 <strong>unblock</strong> 客户端:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* This function is thread safe */</span>
<span class="kt">int</span> <span class="nf">RedisModule_UnblockClient</span><span class="p">(</span><span class="n">RedisModuleBlokcedClient</span> <span class="o">*</span><span class="n">bc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>在客户端解除阻塞之前，会立即调用在客户端被阻塞时指定的 <code>reply_callback</code> 函数：该函数将有权访问此处使用的 <code>privdata</code> 指针。</li>
<li>在客户端解除阻塞之后，会自动调用在客户端被阻塞时指定的 <code>free_private</code> 函数释放 <code>privdata</code> 占用的空间</li>
</ul>
<p><strong>一个简单示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">reply_func</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">RedisModule_ReplyWithSimpleString</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">&#34;765PRO! FIGHT!&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">timeout_func</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">RedisModule_ReplyWithNull</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">threadmain</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RedisModuleBlockedClient</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

    <span class="cm">/* Wait one second and unblock,
</span><span class="cm">     * You can think at it as an actually expansive operation of some kind */</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">RedisModule_UnblockClient</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">Example_RedisCommand</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RedisModuleBlockedClient</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span>
        <span class="n">RedisModule_BlockClient</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reply_func</span><span class="p">,</span> <span class="n">timeout_func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">pthread_t</span> <span class="n">tid</span><span class="p">;</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">threadmian</span><span class="p">,</span> <span class="n">bc</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">REDISMODULE_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="32-passing-reply-data-when-unblocking">3.2. Passing reply data when unblocking</h3>
<p>一般而言阻塞客户端的目的是为了等待某些计算的结果，并将结果回复给客户端，该结果往往是在 unblocked 时传递给 <code>reply_callback</code> 的，我们将上述示例进行简单修改，以演示传递 <code>reply</code> 的过程。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">reply_func</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Obtain the private data */</span>
    <span class="kt">long</span> <span class="o">*</span><span class="n">mynumber</span> <span class="o">=</span> <span class="n">RedisModule_GetBlockedClientPrivateData</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
    <span class="cm">/* Don&#39;t free mynumber here, but in the free private data callback */</span>
    <span class="k">return</span> <span class="n">RedisModule_ReplyWithLongLong</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">mynumber</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">timeout_func</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">RedisModule_ReplyWithNull</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">free_privdata</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RedisModule_Free</span><span class="p">(</span><span class="n">privdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">threadmain</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RedisModuleBlokcedClient</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

    <span class="cm">/* Wait one second and unblock,
</span><span class="cm">     * You can think at it as an actually expansive operation of some kind */</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="kt">long</span> <span class="o">*</span><span class="n">mynumber</span> <span class="o">=</span> <span class="n">RedisModule_Alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
    <span class="o">*</span><span class="n">mynumber</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
    <span class="n">RedisModule_UnblockClient</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">mynumber</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">Example_RedisCommand</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RedisModuleBlockedClient</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span>
        <span class="n">RedisModule_BlockClient</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reply_func</span><span class="p">,</span> <span class="n">timeout_func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">pthread_t</span> <span class="n">tid</span><span class="p">;</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">threadmian</span><span class="p">,</span> <span class="n">bc</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">REDISMODULE_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>privdata</code> 的释放必须放置在 <code>free_privdata</code> callback 中，因为 <code>reply_callback</code> 可能因为客户端连接超时或断开导致无法被调用</li>
<li>在 <code>timeout_callback</code> 中，也可通过 <code>GetBlockedClientPrivateData()</code> 访问 <code>privdata</code></li>
</ul>
<h3 id="33-aborting-the-blocking-of-a-client">3.3. Aborting the blocking of a client</h3>
<p>当实现 Redis Command 的函数中，当申请资源发生错误时，我们既不想 block 客户端，也不想触发 <code>reply_callback</code>，此时我们最好的选择可能是使用以下接口：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">RedisModule_AbortBlock</span><span class="p">(</span><span class="n">RedisModuleBlockedClient</span> <span class="o">*</span><span class="n">bc</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>这时，我们可以将上一小节的 <code>Example_RedisCommand</code> 函数改写如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">Example_RedisCommand</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RedisModuleBlockedClient</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span>
        <span class="n">RedisModule_BlockClient</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reply_func</span><span class="p">,</span> <span class="n">timeout_func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">pthread_t</span> <span class="n">tid</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">threadmain</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">RedisModule_AbortBlock</span><span class="p">(</span><span class="n">bc</span><span class="p">);</span>
        <span class="n">RedisModule_ReplyWithError</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">&#34;Sorry can&#39;t create a thread&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">REDISMODULE_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="34-implementing-the-command-reply-and-timeout-callback-using-a-single-function">3.4. Implementing the command, reply and timeout callback using a single function</h3>
<p>有人可能喜欢将所有实现放在一个函数中，通过使用以下 API 可达到此目的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">RedisModule_IsBlockedReplyRequest</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">RedisModule_IsBlockedTimeoutRequest</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>比如可将之前的示例改写如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="o">*</span><span class="nf">threadmain</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RedisModuleBlokcedClient</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

    <span class="cm">/* Wait one second and unblock,
</span><span class="cm">     * You can think at it as an actually expansive operation of some kind */</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="kt">long</span> <span class="o">*</span><span class="n">mynumber</span> <span class="o">=</span> <span class="n">RedisModule_Alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
    <span class="o">*</span><span class="n">mynumber</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
    <span class="n">RedisModule_UnblockClient</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">mynumber</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">Example_RedisCommand</span><span class="p">(</span><span class="n">RedisModuleCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RedisModuleString</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">RedisModule_IsBlockedReplyRequest</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kt">long</span> <span class="o">*</span><span class="n">mynumber</span> <span class="o">=</span> <span class="n">RedisModule_GetBlockedClientPrivateData</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">RedisModule_ReplyWithLongLong</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">mynumber</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">RedisModule_IsBlockedTimeoutRequest</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">RedisModule_ReplyWithNull</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">RedisModuleBlockedClient</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span>
        <span class="n">RedisModule_BlockClient</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">reply_func</span><span class="p">,</span> <span class="n">timeout_func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">pthread_t</span> <span class="n">tid</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">threadmain</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">RedisModule_AbortBlock</span><span class="p">(</span><span class="n">bc</span><span class="p">);</span>
        <span class="n">RedisModule_ReplyWithError</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">&#34;Sorry can&#39;t create a thread&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">REDISMODULE_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">765PRO.P</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2020-08-19
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://k-on.me/tags/redis/">Redis</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/nvm-notes/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">NVM-notes</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/">
            <span class="next-text nav-default">分布式系统相关笔记</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="pro-765@qq.com" rel="me noopener" class="iconfont"
      title="email"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/yz1509" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://k-on.me/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        765PRO.P
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>



  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>









  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
