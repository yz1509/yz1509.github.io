<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Redis 源码阅读 --- dict - HTT - ふわふわ時間</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="765PRO.P" />
  <meta name="description" content="Redis dict 实现相关源码阅读笔记，源码文件 dict.h &amp;amp; dict.c。
" />

  <meta name="keywords" content="K-ON, KyoAni" />






<meta name="generator" content="Hugo 0.80.0-DEV" />


<link rel="canonical" href="https://k-on.me/post/redis-sourcecode-dict/" />







<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">








<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Redis 源码阅读 --- dict" />
<meta property="og:description" content="Redis dict 实现相关源码阅读笔记，源码文件 dict.h &amp; dict.c。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://k-on.me/post/redis-sourcecode-dict/" />
<meta property="article:published_time" content="2020-09-27T10:15:20+08:00" />
<meta property="article:modified_time" content="2020-09-27T10:15:20+08:00" />
<meta itemprop="name" content="Redis 源码阅读 --- dict">
<meta itemprop="description" content="Redis dict 实现相关源码阅读笔记，源码文件 dict.h &amp; dict.c。">
<meta itemprop="datePublished" content="2020-09-27T10:15:20+08:00" />
<meta itemprop="dateModified" content="2020-09-27T10:15:20+08:00" />
<meta itemprop="wordCount" content="2412">



<meta itemprop="keywords" content="Redis,哈希表," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Redis 源码阅读 --- dict"/>
<meta name="twitter:description" content="Redis dict 实现相关源码阅读笔记，源码文件 dict.h &amp; dict.c。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">HTT</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/about/">About</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/categories/">Categories</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      HTT
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/about/">About</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://k-on.me/categories/">Categories</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Redis 源码阅读 --- dict</h1>
      
      <div class="post-meta">
        <time datetime="2020-09-27" class="post-time">
          2020-09-27
        </time>
        <div class="post-category">
            <a href="https://k-on.me/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"> 数据库 </a>
            
          </div>
        <span class="more-meta"> 2412 words </span>
          <span class="more-meta"> 5 min read </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1-小结">1. 小结</a></li>
    <li><a href="#2-数据结构">2. 数据结构</a></li>
    <li><a href="#3-相关操作">3. 相关操作</a>
      <ul>
        <li><a href="#31-扩容">3.1. 扩容</a></li>
        <li><a href="#32-缩容">3.2. 缩容</a></li>
        <li><a href="#33-rehash">3.3. Rehash</a></li>
        <li><a href="#34-访问">3.4. 访问</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>Redis dict 实现相关源码阅读笔记，源码文件 <code>dict.h</code> &amp; <code>dict.c</code>。</p>
<hr>
<h2 id="1-小结">1. 小结</h2>
<p>在 Redis 中，<code>dict</code> 不仅用于实现不同的对象类型，还用于数据库的实现。</p>
<ul>
<li>可通过自定义哈希、复制、比较和析构函数实现不同的 <code>dictType</code></li>
<li>哈希表使用链地址法处理<strong>哈希冲突</strong></li>
<li>每个 <code>dict</code> 中含有两个哈希表 <code>dictht</code>，以便于实现<strong>渐进式 Rehash</strong></li>
<li>在每次尝试往字典中新增 key-val pair 时，可能会触发<strong>扩容</strong> Rehash:
<ul>
<li>一般情况下，载荷因子大于 <a href="https://github.com/redis/redis/blob/6.2.3/src/dict.c#L994">$1$</a> 即触发扩容，但在使用 <code>dict</code> 实现键空间时还需<a href="https://github.com/redis/redis/blob/6.2.3/src/server.c#L1350">考虑 Rehash 带来的内存使用量突增的情况</a></li>
<li>当 Redis 有子进程在做 RDB saving、AOF rewriting 或 module 相关的任务时，载荷因子需大于 <a href="https://github.com/redis/redis/blob/6.2.3/src/dict.c#L59">$5$</a> 才会触发扩容</li>
</ul>
</li>
<li>一般情况下，当哈希表的载荷因子小于 <a href="https://github.com/redis/redis/blob/6.2.3/src/server.c#L1543">$0.1$</a> 时会触发<strong>缩容</strong>操作
<ul>
<li>当 Redis 有子进程在做 RDB saving、AOF rewriting 或 module 相关的任务时，不会进行缩容操作</li>
</ul>
</li>
</ul>
<p><em>Tips</em></p>
<ul>
<li>
<p>对 $b = 2^n$ 取余</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">a</span> <span class="o">%</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="2-数据结构">2. 数据结构</h2>
<p><code>dict</code> 的数据结构如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">dict</span> <span class="p">{</span>
    <span class="n">dictType</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">;</span>
    <span class="n">dictht</span> <span class="n">ht</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kt">long</span> <span class="n">rehashidx</span><span class="p">;</span> <span class="cm">/* rehashing not in progress if rehashidx == -1 */</span>
    <span class="kt">int16_t</span> <span class="n">pauserehash</span><span class="p">;</span> <span class="cm">/* If &gt;0 rehashing is paused (&lt;0 indicates coding error) */</span>
<span class="p">}</span> <span class="n">dict</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>rehashidx</code> 记录了当前 Rehash 的进度，小于该值的 bucket 均已被迁移至 <code>ht[1]</code></p>
<p><strong>dictType</strong></p>
<p>其中字典类型 <code>dictType</code> 的结构如下，可以看出，用户可以传入各种自定义的操作函数以实现不同的字典类型。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">dictType</span> <span class="p">{</span>
    <span class="cm">/* 自定义哈希值计算函数 */</span>
    <span class="kt">uint64_t</span> <span class="p">(</span><span class="o">*</span><span class="n">hashFunction</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
    <span class="cm">/* 自定义键复制函数 */</span>
    <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">keyDup</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
    <span class="cm">/* 自定义值复制函数 */</span>
    <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">valDup</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>
    <span class="cm">/* 自定义键比较函数 */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">keyCompare</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key2</span><span class="p">);</span>
    <span class="cm">/* 自定义键析构函数 */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">keyDestructor</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
    <span class="cm">/* 自定义值析构函数 */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">valDestructor</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>
    <span class="cm">/* 自定义 Rehash 控制函数 */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">expandAllowed</span><span class="p">)(</span><span class="n">size_t</span> <span class="n">moreMem</span><span class="p">,</span> <span class="kt">double</span> <span class="n">usedRatio</span><span class="p">);</span>
<span class="p">}</span> <span class="n">dictType</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>dictht</strong></p>
<p>可以看到在 <code>dict</code> 中有两个哈希表 <code>dictht</code>，方便实现渐进式 Rehash，以免在字典中数据量较大时 Rehash 操作带来较大延时。</p>
<p><code>dictht</code> 的结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">dictht</span> <span class="p">{</span>
    <span class="n">dictEntry</span> <span class="o">**</span><span class="n">table</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span> <span class="cm">/* size of table */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sizemask</span><span class="p">;</span> <span class="cm">/* size - 1 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">used</span><span class="p">;</span> <span class="cm">/* total dictEntries in table */</span>
<span class="p">}</span> <span class="n">dictht</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">dictEntry</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
    <span class="k">union</span> <span class="p">{</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
        <span class="kt">uint64_t</span> <span class="n">u64</span><span class="p">;</span>
        <span class="kt">int64_t</span> <span class="n">s64</span><span class="p">;</span>
        <span class="kt">double</span> <span class="n">d</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">v</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">dictEntry</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span> <span class="n">dictEntry</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Redis 哈希表使用单向链表解决哈希冲突，新加入的节点 <code>dictEntry</code> 置于 table 中相应 bucket 的头部。</p>
<ul>
<li>在 <code>dictht</code> 中，table 的长度 <code>size</code> 始终为 2 的整数倍(在 <a href="https://github.com/redis/redis/blob/6.2.3/src/dict.c#L1005">_dictNextPower</a> 函数中实现)，而 <code>sizemask = size - 1</code>，从而可以将取余操作转化为位运算</li>
<li>在 <code>dictEntry</code> 中，使用 <code>union</code> 来存储不同类型的值 <code>v</code></li>
</ul>
<p><em>Tips</em>: 对 $b = 2^n$ 取余</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">a</span> <span class="o">%</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>迭代器</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* If safe is set to 1 this is a safe iterator, that means, you can call
</span><span class="cm"> * dictAdd, dictFind, and other functions against the dictionary even while
</span><span class="cm"> * iterating. Otherwise it is a non safe iterator, and only dictNext()
</span><span class="cm"> * should be called while iterating. */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">dictIterator</span> <span class="p">{</span>
    <span class="n">dict</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">index</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">table</span><span class="p">,</span> <span class="n">safe</span><span class="p">;</span>
    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">nextEntry</span><span class="p">;</span>
    <span class="cm">/* unsafe iterator fingerprint for misuse detection. */</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">fingerprint</span><span class="p">;</span>
<span class="p">}</span> <span class="n">dictIterator</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>在 <code>dict</code> 结构中的 <code>pauserehash</code> 表示的是当前正在运行的安全(<code>safe=1</code>)迭代器个数，其值不为 0 时，意味着此时不能进行 <a href="https://github.com/redis/redis/blob/6.2.3/src/dict.c#L207">move bucket</a> 操作。</p>
<h2 id="3-相关操作">3. 相关操作</h2>
<h3 id="31-扩容">3.1. 扩容</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">dictEntry</span> <span class="o">*</span><span class="nf">dictAddRaw</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">dictEntry</span> <span class="o">**</span><span class="n">existing</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>在调用 <a href="https://github.com/redis/redis/blob/6.2.3/src/dict.c#L315">dictAddRaw</a> 尝试往哈希表中添加元素时，会先根据 <code>key</code> 及其哈希值调用 <a href="https://github.com/redis/redis/blob/6.2.3/src/dict.c#L1024">_dictKeyIndex</a> 获取哈希表的 index。<code>_dictKeyIndex</code> 在查找 index 之前会先调用 <a href="https://github.com/redis/redis/blob/6.2.3/src/dict.c#L982">_dictExpandIfNeeded</a> 判断是否需要扩容。扩容需要同时满足以下条件：</p>
<ol>
<li>
<p><code>dict_can_resize</code> 为 $1$ 时，载荷因子大于 $1$；<code>dict_can_resize</code> 为 $0$ 时，载荷因子需大于 $5$</p>
<ul>
<li>从 <a href="https://github.com/redis/redis/blob/6.2.3/src/server.c#L1588">updateDictResizePolicy</a> 可知当 Redis 有子进程在做 RDB saving、AOF rewriting 或 module 相关的任务时，<code>dict_can_resize</code> 为 0</li>
<li>当前的实现除了键空间以外的哈希表，仅需满足该条件即可扩容</li>
</ul>
</li>
<li>
<p>实现键空间相关的哈希表考虑到 Rehash 时的内存使用量突增的情况，还需调用<a href="https://github.com/redis/redis/blob/6.2.3/src/dict.c#L974">dictExpandAllowed</a>判断是否可以扩容</p>
</li>
</ol>
<p>如果正处于 Rehash 状态，<strong>新增</strong>的 <code>dictEntry</code> 会添加至 <code>ht[1]</code>。修改已存在 <code>dictEntry</code> 的值会就地修改。</p>
<p><em>PS:</em> 从 <a href="https://github.com/redis/redis/pull/7954#issuecomment-725544359">redis/pull/7954</a> 可以知道在该 PR 之前的 Rehash 操作后，哈希表的大小每次都是翻 $4$ 倍，而不是 $2$ 倍。</p>
<h3 id="32-缩容">3.2. 缩容</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Resize the table to the minimal size that contains all the elements,
</span><span class="cm"> * but with the invariant of a USED/BUCKETS ratio near to &lt;= 1 */</span>
<span class="kt">int</span> <span class="nf">dictResize</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>当 Redis 有子进程在做 RDB saving、AOF rewriting 或 module 相关的任务时，不会进行缩容操作</li>
<li>缩容后确保哈希表 size 大于等于 <code>DICT_HT_INITIAL_SIZE</code> (4)</li>
<li>缩容后确保载荷因子小于等于 $1$</li>
<li>从 <a href="https://github.com/redis/redis/blob/6.2.3/src/server.c#L1543">htNeedsResize</a> 可知，当哈希表的载荷因子小于 <a href="https://github.com/redis/redis/blob/6.2.3/src/server.h#L170">$0.1$</a> 时会触发缩容操作</li>
</ul>
<p>在以下几种情况下会调用该函数：</p>
<ul>
<li>Redis Server 在 <code>databasesCron</code> 中会调用 <code>tryResizeHashTables</code> 尝试对键空间相关哈希表进行缩容</li>
<li>哈希数据类型在调用 <code>hashTypeDelete</code> 删除一个元素后会判断是否需要缩容</li>
<li>集合数据类型在调用 <code>setTypeRemove</code> 删除一个元素后会判断是否需要缩容</li>
<li>有序集合数据类型在调用 <code>zsetDel</code> or <code>zremrangeGenericCommand</code> or <code>zdiffAlgorithm2</code> 删除元素后会判断是否需要缩容</li>
</ul>
<h3 id="33-rehash">3.3. Rehash</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">dictRehash</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>在每次调用 <code>dictRehash</code> 时，最多迁移 $n$ 个非空 bucket，最多迁移 $10 \cdot n$ 个空 bucket</li>
<li>以 bucket 为单位进行迁移，每次迁移完一个 bucket 会相应地增加 <code>d-&gt;rehashidx</code> 值</li>
<li>返回 $1$ 时表示 Rehash 操作还未完成，未处于 Rehash 状态或 Rehash 完成时返回 $0$</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">static</span> <span class="kt">void</span> <span class="nf">_dictRehashStep</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">pauserehash</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">dictRehash</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>在添加(<code>dictAddRaw</code>)、查找(<code>dictFind</code>, <code>dictGetRandomKey</code>, <code>dictGetSomeKeys</code>)、删除(<code>dictGenericDelete</code>) 时，会调用该函数执行渐进式 Rehash，表示如果此时无安全迭代器在遍历哈希表，则会调用 <code>dictRehash(d,1)</code> 迁移 $1$ 个非空 bucket (或 $10$ 个空 bucket)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Rehash for an amount of time between ms milliseconds and ms+1 milliseconds */</span>
<span class="kt">int</span> <span class="nf">dictRehashMilliseconds</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ms</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>在 <code>databasesCron</code> 中会调用该函数尝试对键空间相关的哈希表执行渐进式 Rehash，每次执行时间 <code>ms</code> 设置为 $1ms$，但由于在该函数的循环中是每次先调用 <code>dictRehash(d,100)</code> 再判断当前耗时是否超过 <code>ms</code>，因此这个执行时间限制只是一个软限制。</li>
</ul>
<h3 id="34-访问">3.4. 访问</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* Return a random entry from the hash table. Useful to
</span><span class="cm"> * implement randomized algorithms */</span>
<span class="n">dictEntry</span> <span class="o">*</span><span class="nf">dictGetRandomKey</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>首先随机选择一个非空的 bucket，然后从该 bucket 中随机选择一个 <code>dictEntry</code> 作为返回值。可以看出，长度越短的 bucket 中的 <code>dictEntry</code> 被选中的概率越大。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* This function samples the dictionary to return a few keys from random
</span><span class="cm"> * locations. */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dictGetSomeKeys</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">dictEntry</span> <span class="o">**</span><span class="n">des</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>函数返回时，在 <code>des</code> 中存储采样所得的 <code>dictEntry</code> 数组结果，不保证元素不会重复，<code>des</code> 所指的内存空闲需能容纳 <code>count</code> 个 <code>dictEntry</code> 指针</li>
<li>函数返回值为 <code>des</code> 中包含的 <code>dictEntry</code> 个数，其可能小于 <code>count</code></li>
<li>比调用 <code>count</code> 次 <code>dictGetRandomKey</code> 高效</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* This is like dictGetRandomKey() from the POV of the API, but will do more
</span><span class="cm"> * work to ensure a better distribution of the returned element. */</span>
<span class="n">dictEntry</span> <span class="o">*</span><span class="nf">dictGetFairRandomKey</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>会先尝试调用 <code>dictGetSomeKeys</code> 获取 <code>GETFAIR_NUM_ENTRIES</code> 个 <code>dictEntry</code>，再随机挑选一个返回</li>
<li>调用 <code>dictGetSomeKeys</code> 返回值为 0 时，直接调用 <code>dictGetRandomKey</code>，返回其结果</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/* dictScan() is used to iterate over the elements of a dictionary. */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dictScan</span><span class="p">(</span><span class="n">dict</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
                       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cursor</span><span class="p">,</span>
                       <span class="n">dictScanFunction</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span>
                       <span class="n">dictScanBucketFunction</span> <span class="o">*</span><span class="n">bucketfn</span><span class="p">,</span>
                       <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>Scan 开始时，设置 <code>cursor = 0</code> 调用该函数</p>
</li>
<li>
<p>该函数每次迭代后，返回 <code>cursor</code> 用于下次调用</p>
</li>
<li>
<p>当返回的 <code>cursor</code> 等于 0 时，表示 Scan 结束</p>
</li>
<li>
<p>保证返回所有 <code>dictEntry</code>，但不保证不重复</p>
</li>
<li>
<p>如下所示，<code>cursor</code> 并不是按序递增，而是按位反转之后递增，利用 <code>dictht-&gt;size</code> 是 $2$ 的整数倍的条件，这保证了在 Rehash 时不会漏掉 bucket。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">cursor</span> <span class="o">=</span> <span class="n">rev</span><span class="p">(</span><span class="n">cursor</span><span class="p">);</span>
<span class="n">cursor</span><span class="o">++</span><span class="p">;</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">rev</span><span class="p">(</span><span class="n">cursor</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">765PRO.P</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2020-09-27
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://k-on.me/tags/redis/">Redis</a>
          <a href="https://k-on.me/tags/%E5%93%88%E5%B8%8C%E8%A1%A8/">哈希表</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/redis-sourcecode-intset/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Redis 源码阅读 --- intset</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/redis-sourcecode-quicklist/">
            <span class="next-text nav-default">Redis 源码阅读 --- quicklist</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="pro-765@qq.com" rel="me noopener" class="iconfont"
      title="email"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/yz1509" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://k-on.me/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        765PRO.P
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>



  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>









  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>












</body>
</html>
